<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Stefy - Tu asistente personal avanzado con IA">
    <meta name="theme-color" content="#4a6bff">
    <title>Stefy - Asistente Personal Avanzado</title>

    <!-- PWA Meta Tags -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Stefy">

    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #1a1d2e;
            --secondary-dark: #242837;
            --tertiary-dark: #2d3250;
            --accent-blue: #4a6bff;
            --accent-blue-hover: #5b7cff;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #3c4043;
            --success-green: #34a853;
            --error-red: #ea4335;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: var(--primary-dark);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* LOGIN SCREEN */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--tertiary-dark) 100%);
        }

        .login-container {
            background: var(--secondary-dark);
            border-radius: 16px;
            padding: 48px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            max-width: 400px;
            width: 90%;
        }

        .login-logo {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 14px;
        }

        .google-btn {
            background: white;
            color: #1f1f1f;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .google-btn:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }

        .permissions-info {
            margin-top: 24px;
            padding: 16px;
            background: var(--tertiary-dark);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* MAIN APP LAYOUT */
        .app-container {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .app-container.active {
            display: flex;
        }

        /* HEADER */
        .app-header {
            background: var(--secondary-dark);
            padding: 8px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            z-index: 100;
            height: 56px;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
        }

        .app-logo-icon {
            font-size: 28px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            height: 100%;
        }

        /* Hamburger Menu Button */
        .hamburger-btn {
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin-right: 8px;
        }

        .hamburger-btn:hover {
            background: var(--tertiary-dark);
        }

        .hamburger-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Side Menu Overlay */
        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .side-menu-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: var(--secondary-dark);
            border-right: 1px solid var(--border-color);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            transition: left 0.3s ease;
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.3);
        }

        .side-menu.active {
            left: 0;
        }

        .side-menu-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .side-menu-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .side-menu-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .side-menu-close:hover {
            background: var(--tertiary-dark);
            color: var(--text-primary);
        }

        .side-menu-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .side-menu-item {
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }

        .side-menu-item:hover {
            background: var(--tertiary-dark);
        }

        .side-menu-item svg {
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
        }

        .side-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 8px 20px;
        }

        .side-menu-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.2);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        /* User Menu Dropdown */
        .user-menu {
            position: fixed;
            top: 60px;
            right: 80px;
            background: var(--secondary-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            min-width: 280px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 10000;
        }

        /* RTL: Menú a la izquierda en hebreo */
        [dir="rtl"] .user-menu {
            right: auto;
            left: 80px;
        }

        .user-menu.show {
            display: block;
            animation: fadeIn 0.2s;
        }

        .user-menu-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-menu-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
        }

        .user-menu-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-menu-info {
            flex: 1;
            min-width: 0;
        }

        .user-menu-name {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-menu-email {
            font-size: 13px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        .user-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            font-size: 14px;
            transition: background 0.2s;
        }

        .user-menu-item:hover {
            background: var(--tertiary-dark);
        }

        .user-menu-item.danger {
            color: var(--error-red);
        }

        .user-menu-item.danger:hover {
            background: rgba(220, 53, 69, 0.1);
        }

        .user-menu-item .badge {
            margin-left: auto;
            background: var(--accent-blue);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(16, 185, 129, 0.15);
            border: 1.5px solid rgba(16, 185, 129, 0.4);
            color: #10b981;
            height: 24px;
        }

        .connection-status .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
            animation: pulse 2s infinite;
        }

        .connection-status.offline {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.4);
            color: #ef4444;
        }

        .connection-status.offline .status-dot {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
        }

        .connection-status.online .status-dot {
            background: #10b981;
        }

        .connection-status.offline .status-dot {
            background: #ef4444;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .theme-toggle {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            position: relative;
            top: 0px;
            margin-top: 0;
        }

        .theme-toggle:hover {
            background: var(--accent-blue);
            color: white;
            transform: rotate(20deg) scale(1.1);
        }

        .language-selector {
            background: var(--tertiary-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .language-selector:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* Selector de idioma moderno */
        .language-selector-wrapper {
            position: relative;
        }

        .language-selector-modern {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 2px solid rgba(102, 126, 234, 0.3);
            color: var(--text-primary);
            padding: 8px 16px;
            padding-right: 36px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23667eea' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .language-selector-modern:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .language-selector-modern:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        /* Estilo para las opciones del dropdown */
        .language-selector-modern option {
            background-color: var(--secondary-dark);
            color: var(--text-primary);
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
        }

        .language-selector-modern option:hover {
            background-color: var(--tertiary-dark);
        }

        .language-selector-modern option:checked {
            background-color: #667eea;
            color: #FFFFFF;
            font-weight: 600;
        }

        /* Tema claro */
        .light-theme .language-selector-modern option {
            background-color: #FFFFFF;
            color: #1a1a2e;
        }

        .light-theme .language-selector-modern option:checked {
            background-color: #667eea;
            color: #FFFFFF;
        }

        .language-selector:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* MAIN CONTENT - 3 PANELS */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .panel {
            background: var(--secondary-dark);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .panel-left {
            width: 25%;
            min-width: 250px;
        }

        .panel-center {
            width: 50%;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .panel-right {
            width: 25%;
            min-width: 250px;
            border-right: none;
        }

        /* PANEL HEADERS */
        .panel-header {
            padding: 16px 20px;
            background: var(--tertiary-dark);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        /* Widget Config Button */
        .widget-config-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .widget-config-btn:hover {
            background: var(--secondary-dark);
            color: var(--text-primary);
        }

        .widget-config-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Widget Config Modal */
        .widget-config-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .widget-config-overlay.active {
            display: flex;
            opacity: 1;
        }

        .widget-config-modal {
            background: var(--secondary-dark);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .widget-config-overlay.active .widget-config-modal {
            transform: scale(1);
        }

        .widget-config-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .widget-config-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .widget-config-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .widget-config-close:hover {
            background: var(--tertiary-dark);
            color: var(--text-primary);
        }

        .widget-config-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
        }

        .widget-category {
            margin-bottom: 24px;
        }

        .widget-category-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .widget-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .widget-option:hover {
            background: var(--tertiary-dark);
        }

        .widget-option-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .widget-option.active .widget-option-checkbox {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .widget-option-checkbox svg {
            width: 14px;
            height: 14px;
            color: white;
            display: none;
        }

        .widget-option.active .widget-option-checkbox svg {
            display: block;
        }

        .widget-option-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .widget-option-info {
            flex: 1;
        }

        .widget-option-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .widget-option-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .widget-config-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .widget-count {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .widget-config-actions {
            display: flex;
            gap: 8px;
        }

        .widget-config-btn-save,
        .widget-config-btn-cancel {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .widget-config-btn-save {
            background: var(--accent-blue);
            color: white;
        }

        .widget-config-btn-save:hover {
            background: var(--accent-blue-hover);
        }

        .widget-config-btn-cancel {
            background: var(--tertiary-dark);
            color: var(--text-primary);
        }

        .widget-config-btn-cancel:hover {
            background: var(--secondary-dark);
        }

        /* LEFT PANEL - FILES */
        .search-box {
            margin: 16px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            background: var(--tertiary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .folder-list,
        .file-list {
            padding: 8px;
        }

        .folder-item,
        .file-item {
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .folder-item:hover,
        .file-item:hover {
            background: var(--tertiary-dark);
        }

        .folder-icon,
        .file-icon {
            font-size: 18px;
        }

        .folder-name,
        .file-name {
            font-size: 14px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ÁRBOL EXPANDIBLE TIPO GOOGLE DRIVE */
        .folder-tree-item {
            margin-bottom: 2px;
        }

        .folder-header {
            padding: 8px 8px 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            user-select: none;
        }

        .folder-header:hover {
            background: var(--tertiary-dark);
        }

        .folder-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }

        .folder-toggle.expanded {
            transform: rotate(90deg);
        }

        .folder-contents {
            display: none;
            padding-left: 24px;
            margin-top: 2px;
        }

        .folder-contents.expanded {
            display: block;
        }

        .file-item-nested {
            padding: 6px 8px;
            margin-bottom: 2px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            transition: background 0.2s;
        }

        .file-item-nested:hover {
            background: var(--tertiary-dark);
        }

        .file-item-nested .file-icon {
            font-size: 16px;
        }

        .folder-loading {
            padding: 8px 12px;
            font-size: 12px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .section-title {
            padding: 16px 12px 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.2s;
        }

        .section-title:hover {
            color: var(--text-primary);
        }

        .section-toggle {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            max-height: 400px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .folders-list,
        .recent-files-list,
        .trash-list {
            padding: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .folders-list::-webkit-scrollbar,
        .recent-files-list::-webkit-scrollbar,
        .trash-list::-webkit-scrollbar {
            width: 6px;
        }

        .folders-list::-webkit-scrollbar-thumb,
        .recent-files-list::-webkit-scrollbar-thumb,
        .trash-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .trash-item {
            padding: 8px 12px;
            margin-bottom: 2px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            transition: background 0.2s;
            opacity: 0.7;
        }

        .trash-item:hover {
            background: var(--tertiary-dark);
            opacity: 1;
        }

        .trash-icon {
            font-size: 16px;
        }

        /* CENTER PANEL - CHAT */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 120px; /* Espacio para el input */
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; /* iOS smooth scroll */
        }

        /* Scroll suave personalizado */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            transition: background 0.3s;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 80%;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
        }

        .message-content {
            background: var(--tertiary-dark);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: var(--accent-blue);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .typing-indicator {
            display: none !important;
        }

        .typing-indicator.active {
            display: flex !important;
        }

        .typing-indicator .message-content {
            background: var(--tertiary-dark);
            padding: 12px 16px;
            border-radius: 12px;
            width: fit-content;
        }

        .typing-dots {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-10px);
            }
        }

        /* CHAT INPUT - WHATSAPP STYLE */
        .chat-input-container {
            position: fixed;
            bottom: 0;
            left: 25%; /* Ancho del panel izquierdo */
            right: 25%; /* Ancho del panel derecho */
            padding: 10px 16px;
            background: var(--secondary-dark);
            border-top: 1px solid var(--border-color);
            z-index: 100;
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            background: transparent;
        }

        .chat-input {
            flex: 1;
            background: var(--tertiary-dark);
            border: 1px solid transparent;
            border-radius: 24px;
            padding: 12px 20px;
            color: var(--text-primary);
            font-size: 15px;
            resize: none;
            max-height: 120px;
            font-family: inherit;
            line-height: 1.5;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn.attach {
            background: transparent;
        }

        .action-btn.voice {
            background: transparent;
        }

        .action-btn.voice.recording {
            color: var(--error-red);
            animation: pulse 1s infinite;
        }

        .action-btn#sendBtn {
            background: var(--accent-blue);
            color: white;
            margin-left: 4px;
        }

        .action-btn#sendBtn:hover {
            background: var(--accent-blue-hover);
            box-shadow: 0 2px 8px rgba(74, 107, 255, 0.3);
        }

        /* SVG ICONS */
        .icon-svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .icon-svg-sm {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        /* RIGHT PANEL - WIDGETS */
        .widgets-grid {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .widget-card {
            background: var(--tertiary-dark);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            border: 1px solid transparent;
        }

        .widget-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .widget-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .widget-label {
            font-size: 13px;
            font-weight: 500;
        }

        .quick-summary {
            margin: 16px;
            padding: 16px;
            background: var(--tertiary-dark);
            border-radius: 12px;
        }

        .summary-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 13px;
            border-bottom: 1px solid var(--border-color);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-value {
            color: var(--accent-blue);
            font-weight: 600;
        }

        /* CONNECTION STATUS */
        .connection-status {
            position: fixed;
            top: 60px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 6px;
            z-index: 1000;
        }

        .connection-status.online {
            background: var(--success-green);
            display: flex;
        }

        .connection-status.offline {
            background: var(--error-red);
            display: flex;
        }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .panel-left,
            .panel-right {
                display: none;
            }

            .panel-center {
                width: 100%;
            }

            .mobile-nav {
                display: flex;
                background: var(--secondary-dark);
                border-top: 1px solid var(--border-color);
                padding: 8px;
                justify-content: space-around;
            }

            .mobile-nav-btn {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                padding: 8px 16px;
                background: none;
                border: none;
                color: var(--text-secondary);
                cursor: pointer;
                font-size: 20px;
                border-radius: 8px;
            }

            .mobile-nav-btn.active {
                color: var(--accent-blue);
                background: var(--tertiary-dark);
            }

            .mobile-nav-label {
                font-size: 11px;
            }
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* ========================================
           PAQUETE 1 - NUEVOS ESTILOS
           ======================================== */

        /* 1. Botones de acción rápida */
        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            background: var(--tertiary-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }

        .quick-action-btn:active {
            transform: translateY(0);
        }

        /* 2. Indicador de subida */
        .upload-indicator {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary-dark);
            padding: 12px 24px;
            border-radius: 24px;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: 1px solid var(--border-color);
        }

        .upload-indicator.show {
            display: flex;
        }

        .upload-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* 3. Preview de imágenes */
        .message-image-preview {
            max-width: 250px;
            max-height: 250px;
            border-radius: 8px;
            margin-top: 8px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-image-preview:hover {
            transform: scale(1.02);
        }

        /* 4. Mensajes de voz reproducibles */
        .voice-message-player {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--tertiary-dark);
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            min-width: 200px;
        }

        .play-voice-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-blue);
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .play-voice-btn:hover {
            background: var(--accent-blue-hover);
            transform: scale(1.1);
        }

        .play-voice-btn.playing {
            background: var(--error-red);
        }

        .voice-waveform {
            flex: 1;
            height: 24px;
            background: linear-gradient(90deg,
                    var(--accent-blue) 0%,
                    var(--accent-blue) var(--progress, 0%),
                    var(--border-color) var(--progress, 0%),
                    var(--border-color) 100%);
            border-radius: 4px;
        }

        .voice-duration {
            font-size: 12px;
            color: var(--text-secondary);
            min-width: 40px;
        }

        /* 5. Confirmación visual (✓✓) */
        .message-status {
            display: flex;
            gap: 2px;
            margin-left: 8px;
            font-size: 12px;
        }

        .message-status .check {
            color: var(--text-secondary);
            transition: color 0.3s;
        }

        .message-status .check.received {
            color: var(--accent-blue);
        }

        /* 6. Drag & Drop visual */
        .chat-messages.drag-over {
            border: 2px dashed var(--accent-blue) !important;
            background: rgba(74, 107, 255, 0.05) !important;
        }

        .drag-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(74, 107, 255, 0.1);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 100;
            pointer-events: none;
        }

        .drag-overlay.show {
            display: flex;
        }

        /* 7. Múltiples archivos */
        .multiple-files-preview {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-preview-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--tertiary-dark);
            border-radius: 6px;
            font-size: 14px;
        }

        .file-preview-item .remove-file {
            margin-left: auto;
            background: transparent;
            border: none;
            color: var(--error-red);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .file-preview-item .remove-file:hover {
            background: rgba(234, 67, 53, 0.1);
        }

        /* Animaciones suaves para nuevos elementos */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-up {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ========================================
           BOTÓN NUEVA CARPETA Y MODAL
           ======================================== */

        .new-folder-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .new-folder-btn:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
            transform: scale(1.05);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            display: flex;
            animation: fadeIn 0.2s;
        }

        .modal-content {
            background: var(--secondary-dark);
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.3s;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--text-primary);
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--tertiary-dark);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-body label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .modal-body input {
            width: 100%;
            padding: 12px;
            background: var(--tertiary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            box-sizing: border-box;
        }

        .modal-body input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-secondary,
        .btn-primary {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: var(--tertiary-dark);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-blue-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 107, 255, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ========================================
           MENÚ CONTEXTUAL
           ======================================== */

        .context-menu {
            position: fixed;
            background: var(--secondary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 4px 0;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            display: none;
        }

        .context-menu.show {
            display: block;
            animation: fadeIn 0.15s;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            font-size: 14px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: var(--tertiary-dark);
        }

        .context-menu-item.danger {
            color: var(--error-red);
        }

        .context-menu-item.danger:hover {
            background: rgba(220, 53, 69, 0.1);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* ========================================
           PAQUETE 2 - NUEVOS ESTILOS
           ======================================== */

        /* 1. Tema Claro */
        body.light-theme {
            --primary-dark: #ffffff;
            --secondary-dark: #f8f9fa;
            --tertiary-dark: #e9ecef;
            --accent-blue: #4a6bff;
            --accent-blue-hover: #5b7cff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --success-green: #28a745;
            --error-red: #dc3545;
        }

        /* Botón de tema */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 200px;
            background: var(--tertiary-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: var(--accent-blue);
            color: white;
            transform: rotate(20deg) scale(1.1);
        }

        /* 2. Barra de búsqueda */
        .search-bar {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary-dark);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 8px 16px;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 400px;
        }

        .search-bar.show {
            display: flex;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .search-bar input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .search-bar input::placeholder {
            color: var(--text-secondary);
        }

        .search-bar button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .search-bar button:hover {
            background: var(--tertiary-dark);
            color: var(--text-primary);
        }

        /* 3. Animaciones de mensajes mejoradas */
        .message {
            animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Hover en mensajes */
        .message:hover {
            transform: translateX(2px);
            transition: transform 0.2s;
        }

        /* 4. Scroll suave mejorado */
        .chat-messages {
            scroll-behavior: smooth;
        }

        /* Botón de scroll to bottom */
        .scroll-to-bottom {
            position: absolute;
            bottom: 100px;
            right: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-blue);
            color: white;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(74, 107, 255, 0.3);
            z-index: 100;
            transition: all 0.3s;
        }

        .scroll-to-bottom.show {
            display: flex;
            animation: fadeInScale 0.3s ease;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .scroll-to-bottom:hover {
            background: var(--accent-blue-hover);
            transform: scale(1.1);
        }

        /* 5. Indicador de atajos de teclado */
        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary-dark);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            display: none;
            gap: 16px;
            z-index: 999;
        }

        .keyboard-hint.show {
            display: flex;
        }

        .keyboard-hint kbd {
            background: var(--tertiary-dark);
            border: 1px solid var(--border-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
        }

        /* Mensajes destacados en búsqueda */
        .message.search-highlight {
            background: rgba(74, 107, 255, 0.1);
            border-left: 3px solid var(--accent-blue);
        }

        /* Transiciones suaves globales */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        button,
        .action-btn,
        .quick-action-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        button:active,
        .action-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>
    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">🤖</div>
            <h1 class="login-title">Stefy</h1>
            <p class="login-subtitle">Asistente Personal Avanzado</p>

            <button class="google-btn" onclick="handleGoogleLogin()">
                <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                    <path fill="#EA4335"
                        d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" />
                    <path fill="#4285F4"
                        d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" />
                    <path fill="#FBBC05"
                        d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z" />
                    <path fill="#34A853"
                        d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" />
                    <path fill="none" d="M0 0h48v48H0z" />
                </svg>
                Iniciar con Google
            </button>

            <div class="permissions-info">
                Al iniciar sesión, otorgas acceso a:<br>
                <strong>Drive</strong> • <strong>Calendar</strong> • <strong>Contacts</strong> • <strong>Gmail</strong>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <!-- Botón Hamburguesa -->
            <button class="hamburger-btn" onclick="window.toggleSideMenu()" title="Menú">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>

            <div class="app-logo">
                <svg viewBox="0 0 200 200" class="icon-svg" style="width: 38px; height: 38px;">
                    <defs>
                        <style>
                            .logo-blue { fill: #1da1f2; }
                            .logo-dark { fill: #2c3e50; }
                        </style>
                    </defs>
                    
                    <!-- Círculo externo azul -->
                    <circle cx="100" cy="95" r="75" fill="none" stroke="#1da1f2" stroke-width="12"/>
                    
                    <!-- Círculo interno oscuro -->
                    <circle cx="100" cy="95" r="60" fill="none" stroke="#2c3e50" stroke-width="8"/>
                    
                    <!-- Auricular izquierdo -->
                    <rect x="35" y="75" width="20" height="45" rx="10" class="logo-dark"/>
                    
                    <!-- Auricular derecho -->
                    <rect x="145" y="75" width="20" height="45" rx="10" class="logo-dark"/>
                    
                    <!-- Banda superior (curva) -->
                    <path d="M 55 75 Q 100 40 145 75" fill="none" stroke="#1da1f2" stroke-width="14" stroke-linecap="round"/>
                    
                    <!-- Micrófono -->
                    <path d="M 100 120 Q 105 140 120 145" fill="none" stroke="#2c3e50" stroke-width="10" stroke-linecap="round"/>
                    <ellipse cx="125" cy="147" rx="8" ry="10" class="logo-dark"/>
                    
                    <!-- Burbuja de chat (flecha abajo) -->
                    <path d="M 165 155 L 175 175 L 165 165 Z" class="logo-blue"/>
                </svg>
                <span>Stefy</span>
            </div>

            <div class="header-controls">
                <!-- Botón de tema -->
                <button id="themeToggle" class="theme-toggle" title="Cambiar tema (Ctrl+T)">
                    <!-- Luna por defecto (tema oscuro) -->
                    <svg viewBox="0 0 24 24" class="icon-svg-sm theme-icon-dark">
                        <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z" fill="currentColor"/>
                    </svg>
                    <!-- Sol (tema claro) - oculto por defecto -->
                    <svg viewBox="0 0 24 24" class="icon-svg-sm theme-icon-light" style="display: none;">
                        <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z" fill="currentColor"/>
                    </svg>
                </button>

                <!-- 3. Selector de idioma (mejorado) -->
                <div class="language-selector-wrapper">
                    <select id="languageSelector" class="language-selector-modern" onchange="window.changeLanguage(this.value)">
                        <option value="es">🇪🇸 Español</option>
                        <option value="en">🇺🇸 English</option>
                        <option value="he">🇮🇱 עברית</option>
                    </select>
                </div>

                <!-- 4. User menu -->
                <div class="user-section">
                    <div class="user-avatar" id="userAvatar" onclick="window.toggleUserMenu()">
                        <span id="userInitials">U</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Side Menu Overlay -->
        <div class="side-menu-overlay" id="sideMenuOverlay" onclick="window.closeSideMenu()"></div>

        <!-- Side Menu -->
        <div class="side-menu" id="sideMenu">
            <div class="side-menu-header">
                <span class="side-menu-title">Menú</span>
                <button class="side-menu-close" onclick="window.closeSideMenu()" title="Cerrar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="side-menu-content">
                <!-- Google Drive -->
                <a href="https://drive.google.com" target="_blank" class="side-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>Google Drive</span>
                </a>

                <!-- Google Calendar -->
                <a href="https://calendar.google.com" target="_blank" class="side-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span>Google Calendar</span>
                </a>

                <!-- Google Contacts -->
                <a href="https://contacts.google.com" target="_blank" class="side-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>Google Contacts</span>
                </a>

                <!-- Gmail -->
                <a href="https://mail.google.com" target="_blank" class="side-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    <span>Gmail</span>
                </a>

                <!-- Google Tasks -->
                <a href="https://tasks.google.com" target="_blank" class="side-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 11 12 14 22 4"></polyline>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                    </svg>
                    <span>Google Tasks</span>
                </a>

                <!-- Google Maps -->
                <a href="https://maps.google.com" target="_blank" class="side-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    <span>Google Maps</span>
                </a>

                <!-- Google Photos -->
                <a href="https://photos.google.com" target="_blank" class="side-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <span>Google Photos</span>
                </a>

                <div class="side-menu-divider"></div>

                <!-- Configuración -->
                <button class="side-menu-item" onclick="alert('Configuración - En desarrollo')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6m0-12l-4.5-2.5m9 0L12 7m0 10l-4.5 2.5m9 0L12 17M1 12h6m6 0h6m-12 0l-2.5-4.5m0 9L7 12m10 0l2.5-4.5m0 9L17 12"></path>
                    </svg>
                    <span>Configuración</span>
                </button>

                <!-- Ayuda -->
                <button class="side-menu-item" onclick="alert('Ayuda - En desarrollo')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <span>Ayuda</span>
                </button>

                <!-- Acerca de -->
                <button class="side-menu-item" onclick="window.showAboutModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <span>Acerca de Stefy</span>
                </button>
            </div>

            <div class="side-menu-footer">
                Stefy v2.2 - Asistente Personal<br>
                © 2024 JND AI SYSTEMS
            </div>
        </div>

        <!-- User dropdown menu -->
        <div class="user-menu" id="userMenu">
            <div class="user-menu-header">
                <div class="user-menu-avatar" id="userMenuAvatar">
                    <span id="userMenuInitials">U</span>
                </div>
                <div class="user-menu-info">
                    <div class="user-menu-name" id="userMenuName">Usuario</div>
                    <div class="user-menu-email" id="userMenuEmail"><a href="/cdn-cgi/l/email-protection"
                            class="__cf_email__"
                            data-cfemail="95f0f8f4fcf9d5f0edf4f8e5f9f0bbf6faf8">[email&#160;protected]</a></div>
                </div>
            </div>
            <div class="user-menu-divider"></div>
            <div class="user-menu-item" onclick="window.changeAccount()">
                <svg viewBox="0 0 24 24" class="icon-svg-sm">
                    <path
                        d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                </svg>
                <span>Cambiar cuenta</span>
            </div>
            <div class="user-menu-item" onclick="window.showHiddenFolders()">
                <svg viewBox="0 0 24 24" class="icon-svg-sm">
                    <path
                        d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                </svg>
                <span>Carpetas ocultas</span>
                <span class="badge" id="hiddenFoldersBadge">0</span>
            </div>
            <div class="user-menu-divider"></div>
            <div class="user-menu-item danger" onclick="window.logout()" style="
                padding: 10px 16px;
                margin-top: 4px;
            ">
                <svg viewBox="0 0 24 24" class="icon-svg-sm" style="width: 18px; height: 18px;">
                    <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" />
                </svg>
                <span style="font-size: 14px; font-weight: 500;">Cerrar sesión</span>
            </div>
        </div>

        <!-- PAQUETE 2: Barra de búsqueda -->
        <div class="search-bar" id="searchBar">
            <svg viewBox="0 0 24 24" class="icon-svg-sm" style="color: var(--text-secondary);">
                <path
                    d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
            </svg>
            <input type="text" id="searchInput" placeholder="Buscar en conversación... (Ctrl+F)">
            <button id="closeSearch"><svg viewBox="0 0 24 24" class="icon-svg-sm">
                    <path
                        d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg></button>
        </div>

        <!-- Menú contextual -->
        <div class="context-menu" id="contextMenu">
            <div class="context-menu-item" id="contextOpen">
                <svg viewBox="0 0 24 24" class="icon-svg-sm">
                    <path
                        d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z" />
                </svg>
                <span>Abrir</span>
            </div>
            <div class="context-menu-item" id="contextHide">
                <svg viewBox="0 0 24 24" class="icon-svg-sm">
                    <path
                        d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                </svg>
                <span>Ocultar</span>
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item danger" id="contextDelete">
                <svg viewBox="0 0 24 24" class="icon-svg-sm">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                </svg>
                <span>Eliminar</span>
            </div>
        </div>

        <!-- Menú contextual para papelera -->
        <div class="context-menu" id="trashContextMenu">
            <div class="context-menu-item" id="trashRestore">
                <svg viewBox="0 0 24 24" class="icon-svg-sm">
                    <path
                        d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z" />
                </svg>
                <span>Restaurar</span>
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item danger" id="trashDeletePermanent">
                <svg viewBox="0 0 24 24" class="icon-svg-sm">
                    <path
                        d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
                <span>Eliminar permanentemente</span>
            </div>
        </div>

        <!-- Widget Configuration Modal -->
        <div class="widget-config-overlay" id="widgetConfigOverlay" onclick="if(event.target===this) window.closeWidgetConfig()">
            <div class="widget-config-modal">
                <div class="widget-config-header">
                    <div class="widget-config-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6m0-12l-4.5-2.5m9 0L12 7m0 10l-4.5 2.5m9 0L12 17M1 12h6m6 0h6m-12 0l-2.5-4.5m0 9L7 12m10 0l2.5-4.5m0 9L17 12"></path>
                        </svg>
                        <span>Personalizar Widgets</span>
                    </div>
                    <button class="widget-config-close" onclick="window.closeWidgetConfig()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                
                <div class="widget-config-content" id="widgetConfigContent">
                    <!-- Contenido dinámico generado por JavaScript -->
                </div>
                
                <div class="widget-config-footer">
                    <div class="widget-count" id="widgetCount">Widgets activos: 0</div>
                    <div class="widget-config-actions">
                        <button class="widget-config-btn-cancel" onclick="window.closeWidgetConfig()">Cancelar</button>
                        <button class="widget-config-btn-save" onclick="window.saveWidgetConfig()">Guardar cambios</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para crear carpeta -->
        <div class="modal-overlay" id="createFolderModal" onclick="if(event.target===this) hideCreateFolderModal()">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>📁 Nueva Carpeta</h3>
                    <button class="modal-close" onclick="hideCreateFolderModal()">✕</button>
                </div>
                <div class="modal-body">
                    <label for="newFolderName">Nombre de la carpeta:</label>
                    <input type="text" id="newFolderName" placeholder="Mi Nueva Carpeta" autocomplete="off">
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="hideCreateFolderModal()">Cancelar</button>
                    <button class="btn-primary" onclick="createFolder()">Crear</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- LEFT PANEL - FILES -->
            <aside class="panel panel-left">
                <div class="panel-header" style="justify-content: space-between;">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <svg viewBox="0 0 24 24" class="icon-svg">
                            <path
                                d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z" />
                        </svg>
                        Mis Archivos
                    </span>
                    <button class="new-folder-btn" onclick="showCreateFolderModal()" title="Nueva Carpeta">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                </div>

                <div class="search-box">
                    <span class="search-icon">
                        <svg viewBox="0 0 24 24" class="icon-svg-sm">
                            <path
                                d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                        </svg>
                    </span>
                    <input type="text" id="driveSearchInput" placeholder="Buscar archivos..."
                        onkeypress="if(event.key==='Enter') searchDrive(this.value)">
                </div>

                <div class="section-title" onclick="toggleSection('folders')">
                    <span class="section-toggle" id="folders-toggle">▼</span>
                    <span>Carpetas</span>
                </div>
                <div class="section-content" id="folders-content">
                    <div class="folders-list folder-list">
                        <div class="folder-item">
                            <span class="folder-icon">📂</span>
                            <span class="folder-name">Cargando...</span>
                        </div>
                    </div>
                </div>

                <div class="section-title" onclick="toggleSection('recent')">
                    <span class="section-toggle" id="recent-toggle">▼</span>
                    <span>Archivos Recientes</span>
                </div>
                <div class="section-content" id="recent-content">
                    <div class="recent-files-list file-list">
                        <div class="file-item">
                            <span class="file-icon">📄</span>
                            <span class="file-name">Cargando...</span>
                        </div>
                    </div>
                </div>

                <div class="section-title" onclick="toggleSection('trash')">
                    <span class="section-toggle" id="trash-toggle">▼</span>
                    <span>Papelera</span>
                </div>
                <div class="section-content" id="trash-content">
                    <div class="trash-list">
                        <div class="trash-item">
                            <span class="trash-icon">🗑️</span>
                            <span class="file-name">Cargando...</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- CENTER PANEL - CHAT -->
            <main class="panel panel-center">
                <div class="panel-header">
                    <svg viewBox="0 0 200 200" class="icon-svg" style="width: 26px; height: 26px;">
                        <circle cx="100" cy="95" r="75" fill="none" stroke="#1da1f2" stroke-width="12"/>
                        <circle cx="100" cy="95" r="60" fill="none" stroke="#2c3e50" stroke-width="8"/>
                        <rect x="35" y="75" width="20" height="45" rx="10" fill="#2c3e50"/>
                        <rect x="145" y="75" width="20" height="45" rx="10" fill="#2c3e50"/>
                        <path d="M 55 75 Q 100 40 145 75" fill="none" stroke="#1da1f2" stroke-width="14" stroke-linecap="round"/>
                        <path d="M 100 120 Q 105 140 120 145" fill="none" stroke="#2c3e50" stroke-width="10" stroke-linecap="round"/>
                        <ellipse cx="125" cy="147" rx="8" ry="10" fill="#2c3e50"/>
                        <path d="M 165 155 L 175 175 L 165 165 Z" fill="#1da1f2"/>
                    </svg>
                    Chat con Stefy
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- Welcome Message -->
                    <div class="message ai">
                        <div class="message ai">
                            <div class="message-avatar">
                                <svg viewBox="0 0 200 200" style="width: 36px; height: 36px;">
                                    <circle cx="100" cy="95" r="75" fill="none" stroke="#1da1f2" stroke-width="12"/>
                                    <circle cx="100" cy="95" r="60" fill="none" stroke="#2c3e50" stroke-width="8"/>
                                    <rect x="35" y="75" width="20" height="45" rx="10" fill="#2c3e50"/>
                                    <rect x="145" y="75" width="20" height="45" rx="10" fill="#2c3e50"/>
                                    <path d="M 55 75 Q 100 40 145 75" fill="none" stroke="#1da1f2" stroke-width="14" stroke-linecap="round"/>
                                    <path d="M 100 120 Q 105 140 120 145" fill="none" stroke="#2c3e50" stroke-width="10" stroke-linecap="round"/>
                                    <ellipse cx="125" cy="147" rx="8" ry="10" fill="#2c3e50"/>
                                </svg>
                            </div>
                            <div>
                                <div class="message-content">
                                    ¡Hola! Soy Stefy, tu asistente personal avanzado. Puedo ayudarte con tu calendario,
                                    contactos, documentos, mensajería y más. ¿En qué puedo ayudarte hoy?
                                </div>
                                <div class="message-time" id="welcomeTime"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Typing Indicator como mensaje separado -->
                    <div class="message ai typing-indicator" id="typingIndicator" style="display: none;">
                        <div class="message-avatar">
                            <svg viewBox="0 0 200 200" style="width: 36px; height: 36px;">
                                <circle cx="100" cy="95" r="75" fill="none" stroke="#1da1f2" stroke-width="12"/>
                                <circle cx="100" cy="95" r="60" fill="none" stroke="#2c3e50" stroke-width="8"/>
                                <rect x="35" y="75" width="20" height="45" rx="10" fill="#2c3e50"/>
                                <rect x="145" y="75" width="20" height="45" rx="10" fill="#2c3e50"/>
                                <path d="M 55 75 Q 100 40 145 75" fill="none" stroke="#1da1f2" stroke-width="14" stroke-linecap="round"/>
                                <path d="M 100 120 Q 105 140 120 145" fill="none" stroke="#2c3e50" stroke-width="10" stroke-linecap="round"/>
                                <ellipse cx="125" cy="147" rx="8" ry="10" fill="#2c3e50"/>
                            </svg>
                        </div>
                        <div class="message-content">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>

                    <!-- PAQUETE 2: Botón scroll to bottom -->
                    <button class="scroll-to-bottom" id="scrollToBottom" title="Ir al final">
                        ↓
                    </button>

                    <div class="chat-input-container">
                        <!-- Input oculto para archivos -->
                        <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"
                            style="display: none;">

                        <div class="chat-input-wrapper">
                            <textarea class="chat-input" id="messageInput" placeholder="Escribe tu mensaje..."
                                rows="1"></textarea>
                            <div class="input-actions">
                                <button class="action-btn attach" id="attachBtn" title="Adjuntar archivo">
                                    <svg viewBox="0 0 24 24" class="icon-svg">
                                        <path
                                            d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z" />
                                    </svg>
                                </button>
                                <button class="action-btn voice" id="voiceBtn" title="Grabar audio">
                                    <svg viewBox="0 0 24 24" class="icon-svg">
                                        <path
                                            d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                                        <path
                                            d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                                    </svg>
                                </button>
                                <button class="action-btn clear" id="clearChatBtn" onclick="window.clearChatHistory()" title="Limpiar chat">
                                    <svg viewBox="0 0 24 24" class="icon-svg">
                                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                                    </svg>
                                </button>
                                <button class="action-btn" id="sendBtn" onclick="sendMessage()">
                                    <svg viewBox="0 0 24 24" class="icon-svg" style="fill: white;">
                                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Preview de archivo seleccionado -->
                        <div id="filePreview"
                            style="display: none; padding: 10px; background: var(--tertiary-dark); border-radius: 8px; margin-top: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span id="filePreviewIcon" style="font-size: 24px;">📄</span>
                                <div style="flex: 1;">
                                    <div id="filePreviewName" style="font-size: 14px; font-weight: 500;"></div>
                                    <div id="filePreviewSize" style="font-size: 12px; color: var(--text-secondary);">
                                    </div>
                                </div>
                                <button onclick="clearFileSelection()"
                                    style="background: var(--error-red); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    ✕
                                </button>
                            </div>

                            <!-- NUEVO: Botones de acción rápida -->
                            <div id="quickActions" class="quick-actions" style="display: none;">
                                <button class="quick-action-btn" data-action="factura">🧾 Factura</button>
                                <button class="quick-action-btn" data-action="gasto">💰 Gasto</button>
                                <button class="quick-action-btn" data-action="guardar">💾 Guardar</button>
                            </div>
                        </div>

                        <!-- NUEVO: Indicador de subida -->
                        <div id="uploadIndicator" class="upload-indicator">
                            <div class="upload-spinner"></div>
                            <span>📤 Subiendo archivo...</span>
                        </div>

                        <!-- NUEVO: Overlay para drag & drop -->
                        <div id="dragOverlay" class="drag-overlay">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 16px;">📎</div>
                                <div style="font-size: 18px; font-weight: 500;">Suelta los archivos aquí</div>
                            </div>
                        </div>

                        <!-- Grabadora de audio -->
                        <div id="voiceRecorder"
                            style="display: none; padding: 12px; background: var(--tertiary-dark); border-radius: 8px; margin-top: 8px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="recording-indicator"
                                    style="width: 12px; height: 12px; background: var(--error-red); border-radius: 50%; animation: pulse 1s infinite;">
                                </div>
                                <span id="recordingTime" style="font-size: 14px; font-weight: 500;">0:00</span>
                                <div style="flex: 1;"></div>
                                <button onclick="cancelRecording()"
                                    style="background: var(--error-red); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                    Cancelar
                                </button>
                                <button onclick="stopRecording()"
                                    style="background: var(--accent-blue); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                    Enviar
                                </button>
                            </div>
                        </div>
                    </div>
            </main>

            <!-- RIGHT PANEL - WIDGETS -->
            <aside class="panel panel-right">
                <div class="panel-header">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <svg viewBox="0 0 24 24" class="icon-svg">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" fill="currentColor"/>
                        </svg>
                        <span>Accesos Rápidos</span>
                    </div>
                    <button class="widget-config-btn" onclick="window.openWidgetConfig()" title="Personalizar widgets">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="6" r="2"/>
                            <circle cx="12" cy="12" r="2"/>
                            <circle cx="12" cy="18" r="2"/>
                        </svg>
                    </button>
                </div>

                <div class="widgets-grid" id="widgetsContainer">
                    <!-- Los widgets se generan dinámicamente por JavaScript -->
                </div>

                <div class="quick-summary">
                    <div class="summary-title">
                        📊 <span data-translate="quickSummary">Resumen Rápido</span>
                    </div>
                    <div class="summary-item">
                        <span data-translate="todayEvents">Eventos hoy</span>
                        <span class="summary-value">0</span>
                    </div>
                    <div class="summary-item">
                        <span data-translate="activeContacts">Contactos</span>
                        <span class="summary-value">0</span>
                    </div>
                    <!-- Emails temporalmente deshabilitado -->
                    <div class="summary-item" style="display: none;">
                        <span data-translate="unreadEmails">Emails sin leer</span>
                        <span class="summary-value">0</span>
                    </div>
                    <div class="summary-item" style="display: none;">
                        <span data-translate="monthExpenses">Gastos del mes</span>
                        <span class="summary-value">$0</span>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIÓN
        // ==========================================
        const CONFIG = {
            WEBHOOK_URL: 'https://jnd-projects-n8n.ng9sc3.easypanel.host/webhook-test/antigravity',
            GOOGLE_CLIENT_ID: '640803693022-lvs3j57rbh0fv32595dalmmtrejb5k9h.apps.googleusercontent.com',
            // Si tu webhook requiere autenticación, completa estos campos:
            WEBHOOK_AUTH_TYPE: 'none', // 'none', 'bearer', 'header'
            WEBHOOK_AUTH_TOKEN: '', // Tu token si usas bearer
            WEBHOOK_AUTH_HEADER_NAME: '', // Nombre del header (ej: 'X-Webhook-Secret')
            WEBHOOK_AUTH_HEADER_VALUE: '' // Valor del header
        };

        // ==========================================
        // ESTADO DE LA APLICACIÓN
        // ==========================================
        let currentUser = null;
        let messageHistory = [];
        let selectedFile = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null;
        let recordingInterval = null;

        // PAQUETE 1 - Nuevas variables
        let selectedFiles = []; // Para múltiples archivos
        let currentAudio = null; // Para reproducción de audio
        let savedAudioBlobs = {}; // Almacenar audios para reproducir
        let uploadController = null; // Para cancelar uploads

        // ==========================================
        // MULTI-IDIOMA
        // ==========================================
        let currentLanguage = localStorage.getItem('stefy_language') || 'es';

        const translations = {
            es: {
                // Header y conexión
                connected: 'Conectado',
                disconnected: 'Sin sesión',
                sessionExpired: 'Tu sesión ha expirado. Por favor inicia sesión de nuevo.',
                // Menú usuario
                changeAccount: 'Cambiar cuenta',
                hiddenFolders: 'Carpetas ocultas',
                logout: 'Cerrar sesión',
                // Paneles
                myFiles: 'Mis Archivos',
                quickAccess: 'Accesos Rápidos',
                chatWith: 'Chat con Stefy',
                // Secciones
                folders: 'CARPETAS',
                recentFiles: 'ARCHIVOS RECIENTES',
                trash: 'PAPELERA',
                // Búsqueda
                searchFiles: 'Buscar archivos...',
                // Mensaje
                writeMessage: 'Escribe tu mensaje...',
                // Widgets
                contacts: 'Contactos',
                calendar: 'Calendario',
                news: 'Noticias',
                reminders: 'Recordatorios',
                finance: 'Finanzas',
                football: 'Fútbol',
                quickSummary: 'Resumen Rápido',
                todayEvents: 'Eventos hoy',
                activeContacts: 'Contactos',
                unreadEmails: 'Emails sin leer',
                monthExpenses: 'Gastos del mes'
            },
            en: {
                // Header and connection
                connected: 'Connected',
                disconnected: 'Disconnected',
                sessionExpired: 'Your session has expired. Please sign in again.',
                // User menu
                changeAccount: 'Change account',
                hiddenFolders: 'Hidden folders',
                logout: 'Sign out',
                // Panels
                myFiles: 'My Files',
                quickAccess: 'Quick Access',
                chatWith: 'Chat with Stefy',
                // Sections
                folders: 'FOLDERS',
                recentFiles: 'RECENT FILES',
                trash: 'TRASH',
                // Search
                searchFiles: 'Search files...',
                // Message
                writeMessage: 'Type your message...',
                // Widgets
                contacts: 'Contacts',
                calendar: 'Calendar',
                news: 'News',
                reminders: 'Reminders',
                finance: 'Finance',
                football: 'Football',
                quickSummary: 'Quick Summary',
                todayEvents: 'Events today',
                activeContacts: 'Contacts',
                unreadEmails: 'Unread emails',
                monthExpenses: 'Monthly expenses'
            },
            he: {
                // כותרת וחיבור
                connected: 'מחובר',
                disconnected: 'מנותק',
                sessionExpired: 'פג תוקף ההפעלה. אנא התחבר שוב.',
                // תפריט משתמש
                changeAccount: 'החלף חשבון',
                hiddenFolders: 'תיקיות מוסתרות',
                logout: 'התנתק',
                // פאנלים
                myFiles: 'הקבצים שלי',
                quickAccess: 'גישה מהירה',
                chatWith: 'צ\'אט עם Stefy',
                // חלקים
                folders: 'תיקיות',
                recentFiles: 'קבצים אחרונים',
                trash: 'אשפה',
                // חיפוש
                searchFiles: 'חפש קבצים...',
                // הודעה
                writeMessage: 'כתוב הודעה...',
                // ווידג\'טים
                contacts: 'אנשי קשר',
                calendar: 'לוח שנה',
                news: 'חדשות',
                reminders: 'תזכורות',
                finance: 'כספים',
                football: 'כדורגל',
                quickSummary: 'סיכום מהיר',
                todayEvents: 'אירועים היום',
                activeContacts: 'אנשי קשר',
                unreadEmails: 'מיילים שלא נקראו',
                monthExpenses: 'הוצאות החודש'
            }
        };

        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        // ==========================================
        // SIDE MENU (Hamburger Menu)
        // ==========================================

        window.toggleSideMenu = function() {
            const sideMenu = document.getElementById('sideMenu');
            const overlay = document.getElementById('sideMenuOverlay');
            
            if (sideMenu.classList.contains('active')) {
                closeSideMenu();
            } else {
                sideMenu.classList.add('active');
                overlay.classList.add('active');
            }
        }

        window.closeSideMenu = function() {
            const sideMenu = document.getElementById('sideMenu');
            const overlay = document.getElementById('sideMenuOverlay');
            
            sideMenu.classList.remove('active');
            overlay.classList.remove('active');
        }

        window.showAboutModal = function() {
            closeSideMenu();
            const message = `
╔════════════════════════════════════════╗
║        🤖 STEFY - ASISTENTE PERSONAL        ║
╠════════════════════════════════════════╣
║                                        ║
║  Versión: 2.2                         ║
║  Fecha: Diciembre 2024                ║
║                                        ║
║  Desarrollado por:                    ║
║  JND AI SYSTEMS                       ║
║                                        ║
║  Funcionalidades:                     ║
║  ✅ Google Drive Integration          ║
║  ✅ Google Calendar                   ║
║  ✅ Google Contacts                   ║
║  ✅ Recordatorios                     ║
║  ✅ Chat AI con Claude                ║
║  ✅ Multi-idioma (ES, EN, HE)         ║
║                                        ║
║  Servicios integrados:                ║
║  • Google News                        ║
║  • OneFootball                        ║
║  • Google Finance                     ║
║                                        ║
╚════════════════════════════════════════╝
            `;
            alert(message);
        }

        // ==========================================
        // WIDGET CONFIGURATION SYSTEM
        // ==========================================

        // Definición de todos los widgets disponibles
        const AVAILABLE_WIDGETS = [
            // Productividad
            { id: 'calendar', name: 'Calendario', svg: 'M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z', desc: 'Eventos de hoy y mañana', category: 'productivity', type: 'internal', active: true },
            { id: 'contacts', name: 'Contactos', svg: 'M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z', desc: 'Búsqueda de contactos', category: 'productivity', type: 'internal', active: true },
            { id: 'reminders', name: 'Recordatorios', svg: 'M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z', desc: 'Tus recordatorios', category: 'productivity', type: 'internal', active: true },
            { id: 'gmail', name: 'Gmail', svg: 'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zm16 4l-8 5-8-5v10h16V8zm0-2H4l8 5 8-5z', desc: 'Acceso rápido a Gmail', category: 'productivity', type: 'external', url: 'https://mail.google.com', active: false },
            { id: 'tasks', name: 'Google Tasks', svg: 'M9 11l12 14 22 4M21 12v7c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h11', desc: 'Lista de tareas', category: 'productivity', type: 'external', url: 'https://tasks.google.com', active: false },
            { id: 'keep', name: 'Google Keep', svg: 'M3 5v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2zm16 14H5V5h14v14zm-6-7H9v-2h4V8l3 3-3 3v-2z', desc: 'Notas rápidas', category: 'productivity', type: 'external', url: 'https://keep.google.com', active: false },
            
            // Información
            { id: 'news', name: 'Noticias', svg: 'M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z', desc: 'Google News', category: 'information', type: 'external', url: 'https://news.google.com', active: true },
            { id: 'finance', name: 'Finanzas', svg: 'M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z', desc: 'Google Finance', category: 'information', type: 'external', url: 'https://www.google.com/finance', active: true },
            { id: 'weather', name: 'Clima', svg: 'M12 2c5.5 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2zm0 18c4.41 0 8-3.59 8-8s-3.59-8-8-8-8 3.59-8 8 3.59 8 8 8zm0-14c-3.31 0-6 2.69-6 6h2c0-2.21 1.79-4 4-4s4 1.79 4 4c0 2.21-1.79 4-4 4v2c3.31 0 6-2.69 6-6s-2.69-6-6-6z', desc: 'El tiempo en tu zona', category: 'information', type: 'external', url: 'https://weather.com', active: false },
            
            // Entretenimiento
            { id: 'sports', name: 'Fútbol', svg: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z', desc: 'OneFootball', category: 'entertainment', type: 'external', url: 'https://onefootball.com/en/home', active: true },
            { id: 'youtube', name: 'YouTube', svg: 'M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z', desc: 'Videos y música', category: 'entertainment', type: 'external', url: 'https://youtube.com', active: false },
            { id: 'music', name: 'YouTube Music', svg: 'M12 3v9.3l5-2.9V21h-2v-7.5L9 17V3h3zm0-1H8v16l7-4v7h4V9.3L12 4z', desc: 'Tu música favorita', category: 'entertainment', type: 'external', url: 'https://music.youtube.com', active: false },
            
            // Herramientas
            { id: 'maps', name: 'Google Maps', svg: 'M21 10c0 7-9 13-9 13s-9-6-9-13c0-5 4-9 9-9s9 4 9 9zm-9 3c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4zm0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z', desc: 'Mapas y navegación', category: 'tools', type: 'external', url: 'https://maps.google.com', active: false },
            { id: 'photos', name: 'Google Photos', svg: 'M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z', desc: 'Tus fotos', category: 'tools', type: 'external', url: 'https://photos.google.com', active: false },
            { id: 'translate', name: 'Traductor', svg: 'M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z', desc: 'Google Translate', category: 'tools', type: 'external', url: 'https://translate.google.com', active: false },
        ];

        const WIDGET_CATEGORIES = {
            productivity: 'Productividad',
            information: 'Información',
            entertainment: 'Entretenimiento',
            tools: 'Herramientas'
        };

        // Estado temporal para cambios no guardados
        let tempWidgetConfig = [];

        // Abrir modal de configuración
        window.openWidgetConfig = function() {
            // Cargar configuración actual
            const savedConfig = localStorage.getItem('stefy_widgets_config');
            if (savedConfig) {
                const savedIds = JSON.parse(savedConfig);
                // Actualizar estado de widgets basado en configuración guardada
                AVAILABLE_WIDGETS.forEach(widget => {
                    widget.active = savedIds.includes(widget.id);
                });
            }
            
            // Copiar estado actual a temporal
            tempWidgetConfig = AVAILABLE_WIDGETS.map(w => ({...w}));
            
            // Renderizar contenido del modal
            renderWidgetConfigContent();
            
            // Mostrar modal
            const overlay = document.getElementById('widgetConfigOverlay');
            overlay.classList.add('active');
        };

        // Cerrar modal de configuración
        window.closeWidgetConfig = function() {
            const overlay = document.getElementById('widgetConfigOverlay');
            overlay.classList.remove('active');
        };

        // Guardar configuración
        window.saveWidgetConfig = function() {
            // Actualizar estado principal
            AVAILABLE_WIDGETS.forEach((widget, index) => {
                widget.active = tempWidgetConfig[index].active;
            });
            
            // Guardar en localStorage
            const activeIds = AVAILABLE_WIDGETS.filter(w => w.active).map(w => w.id);
            localStorage.setItem('stefy_widgets_config', JSON.stringify(activeIds));
            
            // Re-renderizar grid de widgets
            renderWidgetsGrid();
            
            // Cerrar modal
            closeWidgetConfig();
        };

        // Toggle widget en configuración temporal
        window.toggleWidgetInConfig = function(widgetId) {
            const widget = tempWidgetConfig.find(w => w.id === widgetId);
            if (widget) {
                widget.active = !widget.active;
                // Re-renderizar para actualizar UI
                renderWidgetConfigContent();
            }
        };

        // Renderizar contenido del modal
        function renderWidgetConfigContent() {
            const content = document.getElementById('widgetConfigContent');
            const categories = {};
            
            // Agrupar widgets por categoría
            tempWidgetConfig.forEach(widget => {
                if (!categories[widget.category]) {
                    categories[widget.category] = [];
                }
                categories[widget.category].push(widget);
            });
            
            let html = '';
            
            // Renderizar cada categoría
            Object.keys(categories).forEach(categoryKey => {
                const categoryName = WIDGET_CATEGORIES[categoryKey] || categoryKey;
                const widgets = categories[categoryKey];
                
                html += '<div class="widget-category">';
                html += '<div class="widget-category-title">' + categoryName + '</div>';
                
                widgets.forEach(widget => {
                    const activeClass = widget.active ? 'active' : '';
                    html += '<div class="widget-option ' + activeClass + '" onclick="window.toggleWidgetInConfig(\'' + widget.id + '\')">';
                    html += '  <div class="widget-option-checkbox">';
                    html += '    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">';
                    html += '      <polyline points="20 6 9 17 4 12"></polyline>';
                    html += '    </svg>';
                    html += '  </div>';
                    html += '  <div class="widget-option-icon"><svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: var(--text-secondary);"><path d="' + widget.svg + '"/></svg></div>';
                    html += '  <div class="widget-option-info">';
                    html += '    <div class="widget-option-name">' + widget.name + '</div>';
                    html += '    <div class="widget-option-desc">' + widget.desc + '</div>';
                    html += '  </div>';
                    html += '</div>';
                });
                
                html += '</div>';
            });
            
            content.innerHTML = html;
            
            // Actualizar contador
            const activeCount = tempWidgetConfig.filter(w => w.active).length;
            document.getElementById('widgetCount').textContent = 'Widgets activos: ' + activeCount;
        }

        // Renderizar grid de widgets
        function renderWidgetsGrid() {
            const container = document.getElementById('widgetsContainer');
            const activeWidgets = AVAILABLE_WIDGETS.filter(w => w.active);
            
            let html = '';
            
            activeWidgets.forEach(widget => {
                // Determinar la acción onclick
                let onclickAction = '';
                if (widget.type === 'internal') {
                    onclickAction = 'openWidget(\'' + widget.id + '\')';
                } else if (widget.type === 'external' && widget.url) {
                    onclickAction = 'window.open(\'' + widget.url + '\', \'_blank\')';
                }
                
                html += '<div class="widget-card" onclick="' + onclickAction + '">';
                html += '  <div class="widget-icon">';
                html += '    <svg viewBox="0 0 24 24" class="icon-svg"><path d="' + widget.svg + '"/></svg>';
                html += '  </div>';
                html += '  <div class="widget-label">' + widget.name + '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        // Inicializar widgets al cargar la página
        function initializeWidgets() {
            // Cargar configuración guardada
            const savedConfig = localStorage.getItem('stefy_widgets_config');
            if (savedConfig) {
                const savedIds = JSON.parse(savedConfig);
                AVAILABLE_WIDGETS.forEach(widget => {
                    widget.active = savedIds.includes(widget.id);
                });
            }
            
            // Renderizar grid inicial
            renderWidgetsGrid();
        }

        window.changeLanguage = function (lang) {
            currentLanguage = lang;
            localStorage.setItem('stefy_language', lang);

            // Aplicar dirección RTL para hebreo
            if (lang === 'he') {
                document.body.dir = 'rtl';
            } else {
                document.body.dir = 'ltr';
            }

            // Actualizar toda la UI
            updateUILanguage();
            updateConnectionStatus();
        }

        function updateUILanguage() {
            // Panel izquierdo - buscar el nodo de texto correcto
            const leftPanelHeaderSpan = document.querySelector('.panel-left .panel-header span');
            if (leftPanelHeaderSpan) {
                // Encontrar todos los nodos de texto (sin el SVG)
                const walker = document.createTreeWalker(
                    leftPanelHeaderSpan,
                    NodeFilter.SHOW_TEXT,
                    null
                );
                let textNode;
                while (textNode = walker.nextNode()) {
                    if (textNode.textContent.trim()) {
                        textNode.textContent = ' ' + t('myFiles');
                        break;
                    }
                }
            }

            // Panel derecho
            const rightPanelHeader = document.querySelector('.panel-right .panel-header');
            if (rightPanelHeader) {
                // Buscar el último nodo de texto
                const walker = document.createTreeWalker(
                    rightPanelHeader,
                    NodeFilter.SHOW_TEXT,
                    null
                );
                let lastTextNode = null;
                let node;
                while (node = walker.nextNode()) {
                    if (node.textContent.trim()) {
                        lastTextNode = node;
                    }
                }
                if (lastTextNode) {
                    lastTextNode.textContent = ' ' + t('quickAccess');
                }
            }

            // Panel central
            const centerPanelHeader = document.querySelector('.panel-center .panel-header');
            if (centerPanelHeader) {
                const walker = document.createTreeWalker(
                    centerPanelHeader,
                    NodeFilter.SHOW_TEXT,
                    null
                );
                let lastTextNode = null;
                let node;
                while (node = walker.nextNode()) {
                    if (node.textContent.trim()) {
                        lastTextNode = node;
                    }
                }
                if (lastTextNode) {
                    lastTextNode.textContent = ' ' + t('chatWith');
                }
            }

            // Secciones - preservar event listeners
            const sectionTitles = document.querySelectorAll('.section-title');
            if (sectionTitles[0]) {
                const span = sectionTitles[0].querySelector('span:last-child');
                if (span) span.textContent = t('folders');
            }
            if (sectionTitles[1]) {
                const span = sectionTitles[1].querySelector('span:last-child');
                if (span) span.textContent = t('recentFiles');
            }
            if (sectionTitles[2]) {
                const span = sectionTitles[2].querySelector('span:last-child');
                if (span) span.textContent = t('trash');
            }

            // Input de búsqueda
            const searchInput = document.getElementById('driveSearchInput');
            if (searchInput) searchInput.placeholder = t('searchFiles');

            // Input de mensaje
            const messageInput = document.getElementById('messageInput');
            if (messageInput) messageInput.placeholder = t('writeMessage');

            // Menú de usuario
            const userMenuItems = document.querySelectorAll('.user-menu-item span:last-child');
            if (userMenuItems[0]) userMenuItems[0].textContent = t('changeAccount');
            if (userMenuItems[1]) userMenuItems[1].textContent = t('hiddenFolders');
            if (userMenuItems[2]) userMenuItems[2].textContent = t('logout');
        }



        // ==========================================
        // MENÚ DE USUARIO Y CONEXIÓN
        // ==========================================

        window.toggleUserMenu = function () {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('show');
        }

        // Cerrar menú al hacer click fuera
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('userMenu');
            const avatar = document.getElementById('userAvatar');
            if (menu && !menu.contains(e.target) && !avatar.contains(e.target)) {
                menu.classList.remove('show');
            }
        });

        window.changeAccount = function () {
            if (confirm('¿Cambiar de cuenta?\n\nEsto cerrará tu sesión actual y podrás iniciar con otra cuenta de Google.')) {
                window.logout();
            }
        }

        window.showHiddenFolders = function () {
            const hiddenFolders = JSON.parse(localStorage.getItem('hidden_folders') || '[]');
            if (hiddenFolders.length === 0) {
                alert('No tienes carpetas ocultas.');
                return;
            }

            if (confirm(`Tienes ${hiddenFolders.length} carpetas ocultas.\n\n¿Quieres mostrarlas todas?`)) {
                localStorage.removeItem('hidden_folders');
                addMessageToChat('✅ Todas las carpetas ocultas se mostrarán de nuevo', 'ai');
                loadDriveFolders();
            }
        }

        window.logout = function () {
            if (confirm('¿Cerrar sesión?\n\nPerderás el acceso hasta que vuelvas a iniciar sesión.')) {
                localStorage.removeItem('stefy_user');
                localStorage.removeItem('google_access_token');
                location.reload();
            }
        }

        // Actualizar estado de conexión
        function updateConnectionStatus() {
            const status = document.getElementById('connectionStatus');
            if (!status) return; // Si no existe el elemento, salir
            
            const statusText = status.querySelector('.status-text');
            const token = localStorage.getItem('google_access_token');

            if (token) {
                status.className = 'connection-status online';
                statusText.textContent = t('connected');
                status.title = 'Sesión activa con Google';
            } else {
                status.className = 'connection-status offline';
                statusText.textContent = t('disconnected');
                status.title = 'No hay sesión activa';
            }
        }

        // Verificar token cada minuto
        setInterval(updateConnectionStatus, 60000);

        // Actualizar información del usuario en el menú
        function updateUserMenu() {
            const user = currentUser;
            if (!user) return;

            const menuAvatar = document.getElementById('userMenuAvatar');
            if (user.picture && menuAvatar) {
                menuAvatar.innerHTML = `<img src="${user.picture}" alt="${user.name}">`;
            }

            const menuName = document.getElementById('userMenuName');
            const menuEmail = document.getElementById('userMenuEmail');
            if (menuName) menuName.textContent = user.name;
            if (menuEmail) menuEmail.textContent = user.email;

            const hiddenFolders = JSON.parse(localStorage.getItem('hidden_folders') || '[]');
            const badge = document.getElementById('hiddenFoldersBadge');
            if (badge) {
                badge.textContent = hiddenFolders.length;
                badge.style.display = hiddenFolders.length > 0 ? 'inline' : 'none';
            }
        }

        // ==========================================
        // GOOGLE OAUTH LOGIN - REAL
        // ==========================================

        // Configuración de Google OAuth

        const SCOPES = [
            'https://www.googleapis.com/auth/userinfo.email',
            'https://www.googleapis.com/auth/userinfo.profile',
            'https://www.googleapis.com/auth/drive',
            'https://www.googleapis.com/auth/drive.file',
            'https://www.googleapis.com/auth/spreadsheets',
            'https://www.googleapis.com/auth/calendar',
            'https://www.googleapis.com/auth/contacts.readonly'
        ].join(' ');

        let tokenClient;
        let accessToken = null;

        // Inicializar Google Identity Services
        function initGoogleAuth() {
            if (typeof google === 'undefined' || !google.accounts) {
                console.error('Google Identity Services no está cargado');
                setTimeout(initGoogleAuth, 500); // Reintentar en 500ms
                return;
            }

            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthResponse
                });
                console.log('Google OAuth inicializado correctamente');
            } catch (error) {
                console.error('Error inicializando Google OAuth:', error);
            }
        }

        window.handleGoogleLogin = function () {
            if (!tokenClient) {
                console.error('Token client no está inicializado');
                alert('Esperando a que se cargue Google... Por favor intenta de nuevo en un momento.');
                initGoogleAuth(); // Intentar inicializar
                return;
            }

            try {
                // Solicitar token de acceso
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } catch (error) {
                console.error('Error al solicitar token:', error);
                alert('Error al iniciar sesión. Por favor recarga la página e intenta de nuevo.');
            }
        }

        async function handleAuthResponse(response) {
            if (response.error) {
                console.error('Error en autenticación:', response);
                alert('Error al iniciar sesión con Google. Por favor intenta de nuevo.');
                return;
            }

            // Guardar token y tiempo de expiración
            accessToken = response.access_token;
            localStorage.setItem('google_access_token', accessToken);
            
            // Calcular tiempo de expiración (expires_in viene en segundos)
            const expiresIn = response.expires_in || 3600; // Por defecto 1 hora
            const expiryTime = Date.now() + (expiresIn * 1000);
            localStorage.setItem('google_token_expiry', expiryTime.toString());
            
            console.log(`Token guardado. Expira en ${expiresIn} segundos (${new Date(expiryTime).toLocaleTimeString()})`);
            
            // Iniciar sistema de refresh automático
            startTokenRefreshTimer();

            // Obtener información del usuario
            try {
                const userInfo = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const userData = await userInfo.json();

                const user = {
                    id: userData.id,
                    name: userData.name,
                    email: userData.email,
                    picture: userData.picture
                };

                loginUser(user);
            } catch (error) {
                console.error('Error obteniendo info del usuario:', error);
                alert('Error al obtener información del usuario.');
            }
        }

        function loginUser(user) {
            currentUser = user;
            localStorage.setItem('stefy_user', JSON.stringify(user));

            // Update UI
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');

            // Set user info
            const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('userInitials').textContent = initials;
            const userMenuInitials = document.getElementById('userMenuInitials');
            if (userMenuInitials) userMenuInitials.textContent = initials;

            if (user.picture) {
                document.getElementById('userAvatar').innerHTML = `<img src="${user.picture}" alt="${user.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            }

            // Set welcome time
            document.getElementById('welcomeTime').textContent = getCurrentTime();

            // Load message history from localStorage
            loadMessageHistory();

            // Restaurar estado de secciones colapsables
            restoreSectionStates();

            // Actualizar menú de usuario y estado
            updateUserMenu();
            updateConnectionStatus();

            // Restaurar idioma guardado
            const savedLanguage = localStorage.getItem('stefy_language') || 'es';
            document.getElementById('languageSelector').value = savedLanguage;
            window.changeLanguage(savedLanguage);

            // NUEVO: Cargar archivos de Drive después del login
            if (accessToken) {
                loadDriveFolders();
                loadRecentFiles();
                loadTrash();
                
                // Actualizar widgets con datos reales
                updateWidgetsSummary();
            }
        }

        // ==========================================
        // SECCIONES COLAPSABLES
        // ==========================================

        function toggleSection(sectionName) {
            const content = document.getElementById(`${sectionName}-content`);
            const toggle = document.getElementById(`${sectionName}-toggle`);

            if (content && toggle) {
                content.classList.toggle('collapsed');
                toggle.classList.toggle('collapsed');

                // Guardar estado
                const isCollapsed = content.classList.contains('collapsed');
                localStorage.setItem(`section_${sectionName}`, isCollapsed ? 'collapsed' : 'expanded');
            }
        }

        function restoreSectionStates() {
            ['folders', 'recent', 'trash'].forEach(sectionName => {
                const state = localStorage.getItem(`section_${sectionName}`);
                if (state === 'collapsed') {
                    const content = document.getElementById(`${sectionName}-content`);
                    const toggle = document.getElementById(`${sectionName}-toggle`);
                    if (content && toggle) {
                        content.classList.add('collapsed');
                        toggle.classList.add('collapsed');
                    }
                }
            });
        }

        // ==========================================
        // GOOGLE DRIVE API
        // ==========================================

        let driveFolders = [];
        let driveFiles = [];

        // Listar carpetas principales
        async function loadDriveFolders() {
            if (!accessToken) {
                console.error('No hay token de acceso');
                const foldersContainer = document.querySelector('.folders-list');
                if (foldersContainer) {
                    foldersContainer.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); font-size: 14px;">No hay sesión activa</div>';
                }
                return;
            }

            // Mostrar loading
            const foldersContainer = document.querySelector('.folders-list');
            if (foldersContainer) {
                foldersContainer.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); font-size: 14px;">Cargando...</div>';
            }

            try {
                const response = await fetch(
                    "https://www.googleapis.com/drive/v3/files?" +
                    "q=mimeType='application/vnd.google-apps.folder' and 'root' in parents and trashed=false" +
                    "&fields=files(id,name,modifiedTime)" +
                    "&orderBy=name" +
                    "&pageSize=50",
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                // Verificar error 401 (token expirado)
                if (response.status === 401) {
                    console.error('Token expirado o inválido');
                    handleTokenExpired();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                driveFolders = data.files || [];

                displayFolders(driveFolders);
                console.log('Carpetas raíz cargadas:', driveFolders.length);
            } catch (error) {
                console.error('Error cargando carpetas:', error);
                if (foldersContainer) {
                    foldersContainer.innerHTML = '<div style="padding: 12px; color: var(--error-red); font-size: 14px;">Error al cargar carpetas. <a href="#" onclick="location.reload()" style="color: var(--accent-blue);">Recargar</a></div>';
                }
            }
        }

        // Función para manejar token expirado
        // ==========================================
        // TOKEN REFRESH AUTOMÁTICO
        // ==========================================
        
        let tokenRefreshTimer = null;
        
        // Verificar si el token está por expirar (faltan menos de 5 minutos)
        function isTokenExpiringSoon() {
            const expiryTime = localStorage.getItem('google_token_expiry');
            if (!expiryTime) return true;
            
            const timeLeft = parseInt(expiryTime) - Date.now();
            const fiveMinutes = 5 * 60 * 1000;
            
            return timeLeft < fiveMinutes;
        }
        
        // Verificar si el token ya expiró
        function isTokenExpired() {
            const expiryTime = localStorage.getItem('google_token_expiry');
            if (!expiryTime) return true;
            
            return Date.now() > parseInt(expiryTime);
        }
        
        // Refrescar token automáticamente
        async function refreshToken() {
            console.log('🔄 Refrescando token...');
            
            if (!tokenClient) {
                console.error('Token client no disponible');
                handleTokenExpired();
                return false;
            }
            
            try {
                // Solicitar nuevo token silenciosamente
                tokenClient.requestAccessToken({ prompt: '' });
                return true;
            } catch (error) {
                console.error('Error refrescando token:', error);
                handleTokenExpired();
                return false;
            }
        }
        
        // Iniciar timer de verificación de token
        function startTokenRefreshTimer() {
            // Limpiar timer anterior si existe
            if (tokenRefreshTimer) {
                clearInterval(tokenRefreshTimer);
            }
            
            // Verificar cada minuto
            tokenRefreshTimer = setInterval(async () => {
                if (isTokenExpired()) {
                    console.warn('⚠️ Token expirado');
                    handleTokenExpired();
                } else if (isTokenExpiringSoon()) {
                    console.log('⏰ Token por expirar, refrescando...');
                    await refreshToken();
                }
            }, 60000); // Cada 60 segundos
            
            console.log('✅ Timer de refresh iniciado');
        }
        
        // Detener timer de refresh
        function stopTokenRefreshTimer() {
            if (tokenRefreshTimer) {
                clearInterval(tokenRefreshTimer);
                tokenRefreshTimer = null;
                console.log('🛑 Timer de refresh detenido');
            }
        }

        function handleTokenExpired() {
            console.warn('❌ Token expirado - limpiando sesión');
            
            // Detener timer
            stopTokenRefreshTimer();
            
            // Limpiar token y usuario
            accessToken = null;
            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_token_expiry');
            localStorage.removeItem('stefy_user');
            
            // Mostrar mensaje amigable
            const message = getTranslation('sessionExpired') || 'Tu sesión ha expirado. Por favor inicia sesión de nuevo.';
            alert(message);
            
            // Recargar página para mostrar login
            location.reload();
        }

        // Listar archivos recientes
        async function loadRecentFiles() {
            if (!accessToken) {
                console.error('No hay token de acceso');
                return;
            }

            try {
                const response = await fetch(
                    "https://www.googleapis.com/drive/v3/files?" +
                    "q=mimeType!='application/vnd.google-apps.folder' and trashed=false" +
                    "&fields=files(id,name,mimeType,modifiedTime,size,iconLink)" +
                    "&orderBy=modifiedTime desc" +
                    "&pageSize=10",
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                // Verificar error 401
                if (response.status === 401) {
                    handleTokenExpired();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                driveFiles = data.files || [];

                displayRecentFiles(driveFiles);
                console.log('Archivos recientes cargados:', driveFiles.length);
            } catch (error) {
                console.error('Error cargando archivos recientes:', error);
            }
        }

        // Listar papelera
        async function loadTrash() {
            if (!accessToken) {
                console.error('No hay token de acceso');
                const trashContainer = document.querySelector('.trash-list');
                if (trashContainer) {
                    trashContainer.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); font-size: 14px;">No hay sesión activa</div>';
                }
                return;
            }

            try {
                const response = await fetch(
                    "https://www.googleapis.com/drive/v3/files?" +
                    "q=trashed=true" +
                    "&fields=files(id,name,mimeType,modifiedTime)" +
                    "&orderBy=modifiedTime desc" +
                    "&pageSize=20",
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                // Verificar error 401
                if (response.status === 401) {
                    handleTokenExpired();
                    return;
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const trashedItems = data.files || [];

                displayTrash(trashedItems);
                console.log('Papelera cargada:', trashedItems.length, 'items');
            } catch (error) {
                console.error('Error cargando papelera:', error);
                const trashContainer = document.querySelector('.trash-list');
                if (trashContainer) {
                    trashContainer.innerHTML = '<div style="padding: 12px; color: var(--error-red); font-size: 14px;">Error al cargar papelera</div>';
                }
            }
        }

        // Mostrar items en papelera
        function displayTrash(items) {
            const trashContainer = document.querySelector('.trash-list');
            if (!trashContainer) return;

            if (items.length === 0) {
                trashContainer.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); font-size: 14px;">Papelera vacía</div>';
                return;
            }

            trashContainer.innerHTML = items.map(item => {
                const icon = item.mimeType === 'application/vnd.google-apps.folder' ? '<svg viewBox="0 0 24 24" class="icon-svg-sm" style="color: #9aa0a6;"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>' : getFileIcon(item.mimeType);
                const itemName = escapeHtml(item.name);
                const itemType = item.mimeType === 'application/vnd.google-apps.folder' ? 'folder' : 'file';
                return `
                    <div class="trash-item" oncontextmenu="showTrashContextMenu(event, '${item.id}', '${itemName.replace(/'/g, "\\'")}', '${itemType}'); return false;">
                        <span class="trash-icon"><svg viewBox="0 0 24 24" class="icon-svg-sm"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></span>
                        <span class="file-icon">${icon}</span>
                        <span class="file-name">${itemName}</span>
                    </div>
                `;
            }).join('');
        }

        // Mostrar carpetas en el panel izquierdo
        // Cache de archivos por carpeta
        const folderFilesCache = {};

        // Mostrar carpetas en árbol expandible
        function displayFolders(folders) {
            const foldersContainer = document.querySelector('.folders-list');
            if (!foldersContainer) return;

            // Obtener carpetas ocultas
            const hiddenFolders = JSON.parse(localStorage.getItem('hidden_folders') || '[]');
            
            // Filtrar carpetas ocultas
            const visibleFolders = folders.filter(folder => !hiddenFolders.includes(folder.id));

            if (visibleFolders.length === 0) {
                foldersContainer.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); font-size: 14px;">No hay carpetas</div>';
                return;
            }

            foldersContainer.innerHTML = visibleFolders.map(folder => {
                const folderName = escapeHtml(folder.name);
                return `
                    <div class="folder-tree-item" data-folder-id="${folder.id}">
                        <div class="folder-header" onclick="toggleFolder('${folder.id}', '${folderName.replace(/'/g, "\\'")}');" oncontextmenu="showContextMenu(event, '${folder.id}', '${folderName.replace(/'/g, "\\'")}', 'folder'); return false;">
                            <span class="folder-toggle">▶</span>
                            <span class="folder-icon"><svg viewBox="0 0 24 24" class="icon-svg-sm" style="color: #9aa0a6;"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                            <span class="folder-name">${folderName}</span>
                        </div>
                        <div class="folder-contents" id="folder-${folder.id}">
                            <div class="folder-loading">Cargando...</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle expandir/colapsar carpeta
        async function toggleFolder(folderId, folderName) {
            const folderItem = document.querySelector(`[data-folder-id="${folderId}"]`);
            if (!folderItem) return;

            const toggle = folderItem.querySelector('.folder-toggle');
            const contents = folderItem.querySelector('.folder-contents');

            // Si ya está expandida, colapsar
            if (contents.classList.contains('expanded')) {
                contents.classList.remove('expanded');
                toggle.classList.remove('expanded');
                return;
            }

            // Expandir
            toggle.classList.add('expanded');
            contents.classList.add('expanded');

            // Si ya están cacheados los archivos, no recargar
            if (folderFilesCache[folderId]) {
                displayFolderFiles(folderId, folderFilesCache[folderId]);
                return;
            }

            // Cargar archivos de la carpeta
            await loadFolderFiles(folderId);
        }

        // Cargar archivos de una carpeta
        async function loadFolderFiles(folderId) {
            if (!accessToken) return;

            const contents = document.getElementById(`folder-${folderId}`);
            if (!contents) return;

            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?` +
                    `q='${folderId}'+in+parents+and+trashed=false` +
                    `&fields=files(id,name,mimeType,modifiedTime,size)` +
                    `&orderBy=name` +
                    `&pageSize=100`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }

                const data = await response.json();
                const files = data.files || [];

                // Cachear archivos
                folderFilesCache[folderId] = files;

                // Mostrar archivos
                displayFolderFiles(folderId, files);

            } catch (error) {
                console.error('Error cargando archivos de carpeta:', error);
                contents.innerHTML = '<div class="folder-loading" style="color: var(--error-red);">Error al cargar</div>';
            }
        }

        // Mostrar archivos dentro de una carpeta
        function displayFolderFiles(folderId, files) {
            const contents = document.getElementById(`folder-${folderId}`);
            if (!contents) return;

            if (files.length === 0) {
                contents.innerHTML = '<div class="folder-loading">Carpeta vacía</div>';
                return;
            }

            // Separar carpetas y archivos
            const folders = files.filter(f => f.mimeType === 'application/vnd.google-apps.folder');
            const regularFiles = files.filter(f => f.mimeType !== 'application/vnd.google-apps.folder');

            let html = '';

            // Primero mostrar subcarpetas expandibles
            folders.forEach(folder => {
                const folderName = escapeHtml(folder.name);
                html += `
                    <div class="folder-tree-item" data-folder-id="${folder.id}" style="margin-left: 0;">
                        <div class="folder-header" onclick="toggleFolder('${folder.id}', '${folderName.replace(/'/g, "\\'")}'); event.stopPropagation();" oncontextmenu="showContextMenu(event, '${folder.id}', '${folderName.replace(/'/g, "\\'")}', 'folder'); return false;">
                            <span class="folder-toggle">▶</span>
                            <span class="folder-icon"><svg viewBox="0 0 24 24" class="icon-svg-sm" style="color: #9aa0a6;"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                            <span class="folder-name">${folderName}</span>
                        </div>
                        <div class="folder-contents" id="folder-${folder.id}">
                            <div class="folder-loading">Cargando...</div>
                        </div>
                    </div>
                `;
            });

            // Luego mostrar archivos
            regularFiles.forEach(file => {
                const icon = getFileIcon(file.mimeType);
                const fileName = escapeHtml(file.name);
                html += `
                    <div class="file-item-nested" onclick="openFileInPanel('${file.id}', '${fileName.replace(/'/g, "\\'")}', '${file.mimeType}')" oncontextmenu="showContextMenu(event, '${file.id}', '${fileName.replace(/'/g, "\\'")}', 'file'); return false;">
                        <span class="file-icon">${icon}</span>
                        <span class="file-name">${fileName}</span>
                    </div>
                `;
            });

            contents.innerHTML = html;
        }

        // Abrir archivo desde el panel (sin mostrar en chat)
        async function openFileInPanel(fileId, fileName, mimeType) {
            if (!accessToken) return;

            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?fields=id,name,mimeType,size,modifiedTime,webViewLink,webContentLink`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                const file = await response.json();

                // Abrir en nueva pestaña
                if (file.webViewLink) {
                    window.open(file.webViewLink, '_blank');
                }
            } catch (error) {
                console.error('Error abriendo archivo:', error);
                alert('Error al abrir el archivo');
            }
        }

        // Mostrar archivos recientes
        function displayRecentFiles(files) {
            const recentContainer = document.querySelector('.recent-files-list');
            if (!recentContainer) return;

            if (files.length === 0) {
                recentContainer.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); font-size: 14px;">No hay archivos recientes</div>';
                return;
            }

            recentContainer.innerHTML = files.map(file => {
                const icon = getFileIcon(file.mimeType);
                const fileName = escapeHtml(file.name);
                return `
                    <div class="file-item" data-file-id="${file.id}" onclick="openFileInPanel('${file.id}', '${fileName.replace(/'/g, "\\'")}', '${file.mimeType}')">
                        <span class="file-icon">${icon}</span>
                        <span class="file-name">${fileName}</span>
                    </div>
                `;
            }).join('');
        }

        // Obtener icono según tipo de archivo
        function getFileIcon(mimeType) {
            if (!mimeType) return '<svg viewBox="0 0 24 24" class="icon-svg-sm"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>';
            if (mimeType.includes('pdf')) return '<svg viewBox="0 0 24 24" class="icon-svg-sm" style="color: #ea4335;"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/></svg>';
            if (mimeType.includes('image')) return '<svg viewBox="0 0 24 24" class="icon-svg-sm" style="color: #ea4335;"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>';
            if (mimeType.includes('video')) return '<svg viewBox="0 0 24 24" class="icon-svg-sm" style="color: #ea4335;"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>';
            if (mimeType.includes('audio')) return '<svg viewBox="0 0 24 24" class="icon-svg-sm" style="color: #ea4335;"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>';
            if (mimeType.includes('spreadsheet') || mimeType.includes('excel')) return '<svg viewBox="0 0 24 24" class="icon-svg-sm" style="color: #34a853;"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>';
            if (mimeType.includes('document') || mimeType.includes('word')) return '<svg viewBox="0 0 24 24" class="icon-svg-sm" style="color: #4a6bff;"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>';
            if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) return '<svg viewBox="0 0 24 24" class="icon-svg-sm" style="color: #fbbc04;"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>';
            if (mimeType.includes('zip') || mimeType.includes('rar')) return '<svg viewBox="0 0 24 24" class="icon-svg-sm"><path d="M20 6h-4c0-2.21-1.79-4-4-4S8 3.79 8 6H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM10 10h4v2h-4v-2zm0 4h4v2h-4v-2zm2-10c1.1 0 2 .9 2 2h-4c0-1.1.9-2 2-2z"/></svg>';
            if (mimeType.includes('folder')) return '<svg viewBox="0 0 24 24" class="icon-svg-sm" style="color: #9aa0a6;"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>';
            return '<svg viewBox="0 0 24 24" class="icon-svg-sm"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>';
        }

        // Buscar archivos en Drive (MEJORADO - muestra en chat)
        async function searchDrive(query) {
            if (!accessToken || !query) return;

            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?` +
                    `q=name+contains+'${encodeURIComponent(query)}'+and+trashed=false` +
                    `&fields=files(id,name,mimeType,modifiedTime,webViewLink)` +
                    `&orderBy=modifiedTime desc` +
                    `&pageSize=20`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                const data = await response.json();
                const files = data.files || [];

                if (files.length === 0) {
                    addMessageToChat(`No se encontraron archivos con: "${query}"`, 'ai');
                } else {
                    // Crear mensaje con resultados clickeables
                    let resultsHTML = `
                        <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            <strong>Resultados para "${query}":</strong> ${files.length} archivos encontrados
                        </div>
                    `;
                    
                    resultsHTML += '<div style="display: flex; flex-direction: column; gap: 8px; width: 100%; max-width: 100%;">';
                    
                    files.forEach(file => {
                        const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
                        const icon = getFileIcon(file.mimeType);
                        const fileName = escapeHtml(file.name);
                        const webLink = file.webViewLink || `https://drive.google.com/file/d/${file.id}/view`;
                        
                        resultsHTML += `
                            <div style="
                                background: var(--tertiary-dark);
                                border: 1px solid var(--border-color);
                                border-radius: 8px;
                                padding: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                gap: 12px;
                                transition: all 0.2s;
                                width: 100%;
                                max-width: 100%;
                                box-sizing: border-box;
                            " 
                            onmouseover="this.style.borderColor='var(--accent-blue)';"
                            onmouseout="this.style.borderColor='var(--border-color)';">
                                <div style="
                                    display: flex; 
                                    align-items: center; 
                                    gap: 10px; 
                                    flex: 1;
                                    min-width: 0;
                                    overflow: hidden;
                                ">
                                    <span style="
                                        font-size: 20px; 
                                        flex-shrink: 0;
                                        width: 24px;
                                        text-align: center;
                                    ">${icon}</span>
                                    <span style="
                                        overflow: hidden; 
                                        text-overflow: ellipsis; 
                                        white-space: nowrap;
                                        flex: 1;
                                        font-size: 14px;
                                        color: var(--text-primary);
                                    ">${fileName}</span>
                                </div>
                                <div style="
                                    display: flex; 
                                    gap: 8px;
                                    flex-shrink: 0;
                                    align-items: center;
                                ">
                                    <button 
                                        onclick="window.open('${webLink}', '_blank')" 
                                        style="
                                            background: var(--accent-blue);
                                            color: white;
                                            border: 1px solid var(--accent-blue);
                                            padding: 8px 14px;
                                            border-radius: 6px;
                                            cursor: pointer;
                                            font-size: 13px;
                                            font-weight: 500;
                                            transition: all 0.2s;
                                            white-space: nowrap;
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                        "
                                        onmouseover="this.style.background='var(--accent-blue-hover)';"
                                        onmouseout="this.style.background='var(--accent-blue)';"
                                        title="Abrir archivo">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                        ${isFolder ? 'Abrir' : 'Ver'}
                                    </button>
                                    ${!isFolder ? `
                                        <button 
                                            onclick="window.open('https://drive.google.com/uc?export=download&id=${file.id}', '_blank')" 
                                            style="
                                                background: var(--secondary-dark);
                                                color: var(--text-primary);
                                                border: 1px solid var(--border-color);
                                                padding: 8px 12px;
                                                border-radius: 6px;
                                                cursor: pointer;
                                                font-size: 13px;
                                                font-weight: 500;
                                                transition: all 0.2s;
                                                white-space: nowrap;
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                min-width: 36px;
                                            "
                                            onmouseover="this.style.background='var(--tertiary-dark)'; this.style.borderColor='var(--accent-blue)';"
                                            onmouseout="this.style.background='var(--secondary-dark)'; this.style.borderColor='var(--border-color)';"
                                            title="Descargar archivo">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                <polyline points="7 10 12 15 17 10"></polyline>
                                                <line x1="12" y1="15" x2="12" y2="3"></line>
                                            </svg>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    resultsHTML += '</div>';
                    
                    addMessageToChat(resultsHTML, 'ai', true);
                }
            } catch (error) {
                console.error('Error buscando en Drive:', error);
                addMessageToChat('Error al buscar archivos. Por favor intenta de nuevo.', 'ai');
            }
        }

        // ==========================================
        // GOOGLE CALENDAR API
        // ==========================================
        
        async function loadTodayEvents() {
            if (!accessToken) {
                console.log('No hay token para Calendar API');
                return;
            }
            
            try {
                // Obtener eventos de hoy
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const response = await fetch(
                    `https://www.googleapis.com/calendar/v3/calendars/primary/events?` +
                    `timeMin=${today.toISOString()}` +
                    `&timeMax=${tomorrow.toISOString()}` +
                    `&singleEvents=true` +
                    `&orderBy=startTime`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                if (response.status === 401) {
                    handleTokenExpired();
                    return;
                }
                
                const data = await response.json();
                const events = data.items || [];
                
                // Actualizar contador en el resumen
                const eventCounter = document.querySelector('[data-translate="todayEvents"]')?.nextElementSibling;
                if (eventCounter) {
                    eventCounter.textContent = events.length;
                }
                
                console.log(`📅 ${events.length} eventos hoy`);
                return events;
                
            } catch (error) {
                console.error('Error cargando eventos de Calendar:', error);
            }
        }
        
        // Cargar eventos de mañana
        async function loadTomorrowEvents() {
            if (!accessToken) {
                console.log('No hay token para Calendar API');
                return;
            }
            
            try {
                // Obtener eventos de mañana
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                const dayAfter = new Date(tomorrow);
                dayAfter.setDate(dayAfter.getDate() + 1);
                
                const response = await fetch(
                    `https://www.googleapis.com/calendar/v3/calendars/primary/events?` +
                    `timeMin=${tomorrow.toISOString()}` +
                    `&timeMax=${dayAfter.toISOString()}` +
                    `&singleEvents=true` +
                    `&orderBy=startTime`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                if (response.status === 401) {
                    handleTokenExpired();
                    return;
                }
                
                const data = await response.json();
                const events = data.items || [];
                
                console.log(`📅 ${events.length} eventos mañana`);
                return events;
                
            } catch (error) {
                console.error('Error cargando eventos de mañana:', error);
            }
        }
        
        // Obtener detalles de un evento
        async function getEventDetails(eventId) {
            if (!accessToken) return null;
            
            try {
                const response = await fetch(
                    `https://www.googleapis.com/calendar/v3/calendars/primary/events/${eventId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                if (response.status === 401) {
                    handleTokenExpired();
                    return null;
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error obteniendo detalles del evento:', error);
                return null;
            }
        }

        // ==========================================
        // GOOGLE CALENDAR API - RECORDATORIOS
        // ==========================================
        
        const REMINDERS_CALENDAR_ID = 'f400af785e4f07dec894e0d23620562561eaeaef5f21fb57ecbbe1c48fa639ae@group.calendar.google.com';
        
        // Cargar recordatorios de hoy
        async function loadRemindersToday() {
            if (!accessToken) {
                console.log('No hay token para Calendar API');
                return;
            }
            
            try {
                // Obtener eventos de hoy del calendario de recordatorios
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const response = await fetch(
                    `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(REMINDERS_CALENDAR_ID)}/events?` +
                    `timeMin=${today.toISOString()}` +
                    `&timeMax=${tomorrow.toISOString()}` +
                    `&singleEvents=true` +
                    `&orderBy=startTime`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                if (response.status === 401) {
                    handleTokenExpired();
                    return;
                }
                
                const data = await response.json();
                const events = data.items || [];
                
                console.log(`📋 ${events.length} recordatorios hoy`);
                return events;
                
            } catch (error) {
                console.error('Error cargando recordatorios de hoy:', error);
            }
        }
        
        // Cargar recordatorios de mañana
        async function loadRemindersTomorrow() {
            if (!accessToken) {
                console.log('No hay token para Calendar API');
                return;
            }
            
            try {
                // Obtener eventos de mañana del calendario de recordatorios
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                const dayAfter = new Date(tomorrow);
                dayAfter.setDate(dayAfter.getDate() + 1);
                
                const response = await fetch(
                    `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(REMINDERS_CALENDAR_ID)}/events?` +
                    `timeMin=${tomorrow.toISOString()}` +
                    `&timeMax=${dayAfter.toISOString()}` +
                    `&singleEvents=true` +
                    `&orderBy=startTime`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                if (response.status === 401) {
                    handleTokenExpired();
                    return;
                }
                
                const data = await response.json();
                const events = data.items || [];
                
                console.log(`📋 ${events.length} recordatorios mañana`);
                return events;
                
            } catch (error) {
                console.error('Error cargando recordatorios de mañana:', error);
            }
        }

        // ==========================================
        // GOOGLE CONTACTS API
        // ==========================================
        
        async function loadContacts() {
            if (!accessToken) {
                console.log('No hay token para Contacts API');
                return;
            }
            
            try {
                // Obtener contactos (máximo 10 más recientes)
                const response = await fetch(
                    `https://people.googleapis.com/v1/people/me/connections?` +
                    `personFields=names,emailAddresses,photos,phoneNumbers&pageSize=10&sortOrder=LAST_MODIFIED_DESCENDING`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                if (response.status === 401) {
                    handleTokenExpired();
                    return;
                }
                
                const data = await response.json();
                const contacts = data.connections || [];
                const totalContacts = data.totalPeople || contacts.length;
                
                // Actualizar contador en el resumen
                const contactCounter = document.querySelector('[data-translate="activeContacts"]')?.nextElementSibling;
                if (contactCounter) {
                    contactCounter.textContent = contacts.length;
                }
                
                console.log(`👥 ${contacts.length} contactos cargados de ${totalContacts} total`);
                return { contacts, totalContacts };
                
            } catch (error) {
                console.error('Error cargando contactos:', error);
            }
        }
        
        // Buscar contactos
        async function searchContacts(query) {
            if (!accessToken || !query) return [];
            
            try {
                const response = await fetch(
                    `https://people.googleapis.com/v1/people:searchContacts?` +
                    `query=${encodeURIComponent(query)}&readMask=names,emailAddresses,photos`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                if (response.status === 401) {
                    handleTokenExpired();
                    return [];
                }
                
                const data = await response.json();
                return data.results || [];
                
            } catch (error) {
                console.error('Error buscando contactos:', error);
                return [];
            }
        }
        
        // ==========================================
        // CARGAR DATOS DE TODAS LAS APIs
        // ==========================================
        
        async function loadAllAPIsData() {
            if (!accessToken) {
                console.log('No hay token, no se pueden cargar las APIs');
                return;
            }
            
            console.log('🔄 Cargando datos de Calendar y Contacts...');
            
            // Cargar en paralelo solo Calendar y Contacts
            await Promise.all([
                loadTodayEvents(),
                loadContacts()
            ]);
            
            console.log('✅ Datos de Calendar y Contacts cargados');
        }

        // ==========================================
        // CREAR CARPETA EN DRIVE
        // ==========================================

        function showCreateFolderModal() {
            const modal = document.getElementById('createFolderModal');
            const input = document.getElementById('newFolderName');
            modal.classList.add('show');
            input.value = '';
            input.focus();

            // Enter para crear
            input.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    createFolder();
                }
            };
        }

        function hideCreateFolderModal() {
            const modal = document.getElementById('createFolderModal');
            modal.classList.remove('show');
        }

        async function createFolder() {
            const input = document.getElementById('newFolderName');
            const folderName = input?.value.trim();

            if (!folderName) {
                alert('Por favor ingresa un nombre para la carpeta');
                if (input) input.focus();
                return;
            }

            if (!accessToken) {
                alert('No hay token de acceso. Por favor inicia sesión de nuevo.');
                return;
            }

            // Obtener botón de forma segura
            const btn = document.querySelector('#createFolderModal .btn-primary');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Creando...';
            }

            try {
                const response = await fetch(
                    'https://www.googleapis.com/drive/v3/files',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: folderName,
                            mimeType: 'application/vnd.google-apps.folder',
                            parents: ['root']
                        })
                    }
                );

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }

                const newFolder = await response.json();
                console.log('Carpeta creada:', newFolder);

                // Cerrar modal
                hideCreateFolderModal();

                // Mostrar mensaje de éxito
                addMessageToChat(`✅ Carpeta "${folderName}" creada exitosamente`, 'ai');

                // Recargar lista de carpetas
                await loadDriveFolders();

            } catch (error) {
                console.error('Error creando carpeta:', error);
                alert('Error al crear la carpeta. Por favor intenta de nuevo.');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = t('create') || 'Crear';
                }
            }
        }

        // ==========================================
        // MENÚ CONTEXTUAL Y ELIMINAR
        // ==========================================

        let contextMenuTarget = null;

        function showContextMenu(event, itemId, itemName, itemType) {
            event.preventDefault();
            event.stopPropagation();

            const menu = document.getElementById('contextMenu');

            // Guardar referencia del item
            contextMenuTarget = { id: itemId, name: itemName, type: itemType };

            // Posicionar menú
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('show');

            return false;
        }

        function hideContextMenu() {
            const menu = document.getElementById('contextMenu');
            menu.classList.remove('show');
            contextMenuTarget = null;
        }

        // Cerrar menú al hacer click fuera
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('contextMenu');
            if (!menu.contains(e.target)) {
                hideContextMenu();
            }
        });

        // Acciones del menú contextual
        document.addEventListener('DOMContentLoaded', () => {
            const contextOpen = document.getElementById('contextOpen');
            const contextHide = document.getElementById('contextHide');
            const contextDelete = document.getElementById('contextDelete');

            if (contextOpen) {
                contextOpen.addEventListener('click', () => {
                    if (contextMenuTarget) {
                        if (contextMenuTarget.type === 'folder') {
                            // Expandir carpeta
                            toggleFolder(contextMenuTarget.id, contextMenuTarget.name);
                        } else {
                            // Abrir archivo
                            openFileInPanel(contextMenuTarget.id, contextMenuTarget.name, '');
                        }
                    }
                    hideContextMenu();
                });
            }

            if (contextHide) {
                contextHide.addEventListener('click', () => {
                    if (contextMenuTarget && contextMenuTarget.type === 'folder') {
                        hideFolder(contextMenuTarget.id, contextMenuTarget.name);
                    }
                    hideContextMenu();
                });
            }

            if (contextDelete) {
                contextDelete.addEventListener('click', () => {
                    if (contextMenuTarget) {
                        deleteItem(contextMenuTarget.id, contextMenuTarget.name, contextMenuTarget.type);
                    }
                    hideContextMenu();
                });
            }
        });

        // Ocultar carpeta (solo frontend)
        function hideFolder(folderId, folderName) {
            if (!confirm(`¿Ocultar carpeta "${folderName}"?\n\nLa carpeta solo se ocultará en esta interfaz, no se eliminará de Google Drive.\n\nPuedes mostrarla de nuevo desde el menú de usuario.`)) {
                return;
            }

            // Obtener carpetas ocultas
            const hiddenFolders = JSON.parse(localStorage.getItem('hidden_folders') || '[]');
            
            // Agregar esta carpeta
            if (!hiddenFolders.includes(folderId)) {
                hiddenFolders.push(folderId);
                localStorage.setItem('hidden_folders', JSON.stringify(hiddenFolders));
                
                // Recargar carpetas
                loadDriveFolders();
                
                // Mensaje en chat
                addMessageToChat(`👁️ Carpeta "${folderName}" ocultada. Puedes mostrarla desde el menú de usuario.`, 'ai');
            }
        }

        // Eliminar carpeta o archivo (mover a papelera)
        async function deleteItem(itemId, itemName, itemType) {
            const typeText = itemType === 'folder' ? 'carpeta' : 'archivo';

            if (!confirm(`¿Estás seguro de eliminar ${typeText} "${itemName}"?\n\nSe moverá a la papelera de Google Drive.`)) {
                return;
            }

            if (!accessToken) {
                alert('No hay token de acceso. Por favor inicia sesión de nuevo.');
                return;
            }

            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${itemId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            trashed: true
                        })
                    }
                );

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error eliminando:', errorText);
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }

                console.log(`${typeText} eliminado:`, itemId);

                // Mostrar mensaje de éxito
                addMessageToChat(`🗑️ ${typeText.charAt(0).toUpperCase() + typeText.slice(1)} "${itemName}" movido a la papelera`, 'ai');

                // Recargar listas
                if (itemType === 'folder') {
                    await loadDriveFolders();
                } else {
                    await loadRecentFiles();
                }

                // Recargar papelera
                await loadTrash();

            } catch (error) {
                console.error('Error eliminando:', error);
                alert(`Error al eliminar ${typeText}. Por favor intenta de nuevo.\n\nDetalle: ${error.message}`);
            }
        }

        // ==========================================
        // MENÚ CONTEXTUAL PAPELERA
        // ==========================================

        let trashContextMenuTarget = null;

        function showTrashContextMenu(event, itemId, itemName, itemType) {
            event.preventDefault();
            event.stopPropagation();

            const menu = document.getElementById('trashContextMenu');

            // Guardar referencia del item
            trashContextMenuTarget = { id: itemId, name: itemName, type: itemType };

            // Posicionar menú
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('show');

            return false;
        }

        function hideTrashContextMenu() {
            const menu = document.getElementById('trashContextMenu');
            menu.classList.remove('show');
            trashContextMenuTarget = null;
        }

        // Cerrar menú de papelera al hacer click fuera
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('trashContextMenu');
            if (menu && !menu.contains(e.target)) {
                hideTrashContextMenu();
            }
        });

        // Event listeners para menú de papelera
        document.addEventListener('DOMContentLoaded', () => {
            const trashRestore = document.getElementById('trashRestore');
            const trashDeletePermanent = document.getElementById('trashDeletePermanent');

            if (trashRestore) {
                trashRestore.addEventListener('click', () => {
                    if (trashContextMenuTarget) {
                        restoreItem(trashContextMenuTarget.id, trashContextMenuTarget.name, trashContextMenuTarget.type);
                    }
                    hideTrashContextMenu();
                });
            }

            if (trashDeletePermanent) {
                trashDeletePermanent.addEventListener('click', () => {
                    if (trashContextMenuTarget) {
                        deletePermanently(trashContextMenuTarget.id, trashContextMenuTarget.name, trashContextMenuTarget.type);
                    }
                    hideTrashContextMenu();
                });
            }
        });

        // Restaurar item de la papelera
        async function restoreItem(itemId, itemName, itemType) {
            const typeText = itemType === 'folder' ? 'carpeta' : 'archivo';

            if (!confirm(`¿Restaurar ${typeText} "${itemName}"?\n\nVolverá a su ubicación original.`)) {
                return;
            }

            if (!accessToken) {
                alert('No hay token de acceso. Por favor inicia sesión de nuevo.');
                return;
            }

            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${itemId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            trashed: false
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }

                console.log(`${typeText} restaurado:`, itemId);

                // Mostrar mensaje de éxito
                addMessageToChat(`♻️ ${typeText.charAt(0).toUpperCase() + typeText.slice(1)} "${itemName}" restaurado exitosamente`, 'ai');

                // Recargar listas
                await loadTrash();
                if (itemType === 'folder') {
                    await loadDriveFolders();
                } else {
                    await loadRecentFiles();
                }

            } catch (error) {
                console.error('Error restaurando:', error);
                alert(`Error al restaurar ${typeText}. Por favor intenta de nuevo.`);
            }
        }

        // Eliminar permanentemente
        async function deletePermanently(itemId, itemName, itemType) {
            const typeText = itemType === 'folder' ? 'carpeta' : 'archivo';

            if (!confirm(`⚠️ ADVERTENCIA: ¿Eliminar PERMANENTEMENTE ${typeText} "${itemName}"?\n\nEsta acción NO se puede deshacer.`)) {
                return;
            }

            if (!accessToken) {
                alert('No hay token de acceso. Por favor inicia sesión de nuevo.');
                return;
            }

            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${itemId}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }

                console.log(`${typeText} eliminado permanentemente:`, itemId);

                // Mostrar mensaje de éxito
                addMessageToChat(`❌ ${typeText.charAt(0).toUpperCase() + typeText.slice(1)} "${itemName}" eliminado permanentemente`, 'ai');

                // Recargar papelera
                await loadTrash();

            } catch (error) {
                console.error('Error eliminando permanentemente:', error);
                alert(`Error al eliminar permanentemente ${typeText}. Por favor intenta de nuevo.`);
            }
        }

        // ==========================================
        // CHAT FUNCTIONALITY
        // ==========================================
        
        // Limpiar historial del chat
        window.clearChatHistory = function() {
            // Confirmar con el usuario
            const confirmed = confirm('¿Estás seguro de que quieres limpiar todo el historial del chat? Esta acción no se puede deshacer.');
            
            if (!confirmed) {
                return;
            }
            
            // Limpiar el contenedor de mensajes
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // Agregar mensaje de bienvenida
            const welcomeMessage = `¡Hola! Soy Stefy, tu asistente personal avanzado. Puedo ayudarte con tu calendario, contactos, documentos, mensajería y más. ¿En qué puedo ayudarte hoy?`;
            addMessageToChat(welcomeMessage, 'ai');
            
            // Opcional: También puedes limpiar el localStorage si guardas el historial allí
            // localStorage.removeItem('chat_history');
            
            console.log('✅ Chat limpiado');
        };
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            // Si hay múltiples archivos
            if (selectedFiles.length > 0) {
                input.value = '';
                input.style.height = 'auto';

                await sendMultipleFiles(message);
                clearFileSelection();
                return;
            }

            // Si hay un solo archivo adjunto
            if (selectedFile) {
                input.value = '';
                input.style.height = 'auto';

                await sendFileMessage(message, selectedFile);
                clearFileSelection();
                return;
            }

            // Si solo hay texto (sin archivo)
            if (!message) return;

            // Clear input
            input.value = '';
            input.style.height = 'auto';

            addMessageToChat(message, 'user');

            // Show typing indicator
            showTypingIndicator();

            // Verificar si es un comando local (Calendar/Contacts)
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('calendario') || lowerMessage.includes('eventos') || lowerMessage.includes('calendar')) {
                await showCalendarWidget();
                return;
            }
            
            if (lowerMessage.includes('contactos') || lowerMessage.includes('contacts')) {
                await showContactsWidget();
                return;
            }

            // Para otros mensajes, intentar enviar a n8n
            try {
                const response = await sendToN8N(message, null);

                // Hide typing indicator
                hideTypingIndicator();

                // Extraer el mensaje de la respuesta
                let stefyMessage = null;

                if (response) {
                    stefyMessage = response.output ||
                        response.response ||
                        response.message ||
                        response.text ||
                        response.original_message;

                    if (typeof response === 'string') {
                        stefyMessage = response;
                    }
                }

                if (stefyMessage) {
                    addMessageToChat(stefyMessage, 'ai');
                } else {
                    console.warn('No se encontró mensaje en la respuesta:', response);
                    addMessageToChat('Recibí tu mensaje correctamente.', 'ai');
                }

            } catch (error) {
                console.error('Error sending message:', error);
                hideTypingIndicator();
                // Respuesta más amigable cuando el webhook falla
                addMessageToChat('¡Hola! Estoy aquí para ayudarte. Puedes pedirme que muestre tu calendario o contactos. 😊', 'ai');
            }
        }

        // PAQUETE 1 - Función para enviar múltiples archivos
        async function sendMultipleFiles(caption) {
            showUploadIndicator();

            const totalFiles = selectedFiles.length;

            // Mostrar mensaje inicial
            addMessageToChat(`📤 Enviando ${totalFiles} archivos...`, 'ai');

            let successCount = 0;
            let errorCount = 0;

            // Enviar cada archivo y esperar su respuesta
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const fileNumber = i + 1;

                // Actualizar indicador
                const indicator = document.getElementById('uploadIndicator');
                indicator.innerHTML = `
                    <div class="upload-spinner"></div>
                    <span>📤 Enviando ${fileNumber}/${totalFiles}: ${file.name}</span>
                `;

                // Enviar archivo y ESPERAR respuesta (con flag isMultiple=true)
                try {
                    await sendFileMessage(caption, file, true);
                    successCount++;

                    // Pausa de 1.5 segundos entre archivos para no saturar
                    if (i < selectedFiles.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1500));
                    }
                } catch (error) {
                    console.error(`Error enviando archivo ${fileNumber}:`, error);
                    errorCount++;
                    addMessageToChat(`⚠️ Error con ${file.name}`, 'ai');
                }
            }

            hideUploadIndicator();

            // Mensaje final de confirmación
            if (errorCount === 0) {
                addMessageToChat(`✅ ${successCount} archivos procesados correctamente.`, 'ai');
            } else {
                addMessageToChat(`⚠️ ${successCount} archivos enviados, ${errorCount} con errores.`, 'ai');
            }
        }

        function showUploadIndicator() {
            const indicator = document.getElementById('uploadIndicator');
            indicator.classList.add('show');
        }

        function hideUploadIndicator() {
            const indicator = document.getElementById('uploadIndicator');
            indicator.classList.remove('show');
        }

        async function sendToN8N(message, fileData = null) {
            const userId = currentUser?.email || 'demo_user';

            const payload = {
                user_id: userId,
                timestamp: new Date().toISOString(),
                'message.voice': null
            };

            // Si hay archivo adjunto
            if (fileData) {
                if (fileData.type === 'audio') {
                    payload['message.voice'] = fileData.base64;
                    payload.chatInput = '';
                } else if (fileData.type === 'image' || fileData.type === 'document') {
                    payload.chatInput = '';  // Vacío cuando es archivo
                    payload.caption = message || '';  // Caption en campo separado
                    payload.file = {
                        name: fileData.name,
                        type: fileData.mimeType,
                        base64: fileData.base64
                    };
                }
            } else {
                // Si es solo texto
                payload.chatInput = message || '';
            }

            console.log('Enviando a n8n:', payload);

            // Preparar headers
            const headers = {
                'Content-Type': 'application/json',
            };

            // Agregar autenticación si está configurada
            if (CONFIG.WEBHOOK_AUTH_TYPE === 'bearer' && CONFIG.WEBHOOK_AUTH_TOKEN) {
                headers['Authorization'] = `Bearer ${CONFIG.WEBHOOK_AUTH_TOKEN}`;
            } else if (CONFIG.WEBHOOK_AUTH_TYPE === 'header' && CONFIG.WEBHOOK_AUTH_HEADER_NAME) {
                headers[CONFIG.WEBHOOK_AUTH_HEADER_NAME] = CONFIG.WEBHOOK_AUTH_HEADER_VALUE;
            }

            const response = await fetch(CONFIG.WEBHOOK_URL, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payload)
            });

            console.log('Response status:', response.status);
            console.log('Response headers:', [...response.headers.entries()]);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                throw new Error(`Error ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            console.log('Respuesta de n8n:', data);

            return data;
        }

        function addMessageToChat(text, sender, allowHtml = false) {
            const messagesContainer = document.getElementById('chatMessages');
            if (!messagesContainer) {
                console.error('Chat messages container not found');
                return null;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            // Obtener iniciales de forma segura
            let userInitials = 'U';
            const initialsElement = document.getElementById('userInitials');
            if (initialsElement && initialsElement.textContent) {
                userInitials = initialsElement.textContent;
            } else if (currentUser && currentUser.name) {
                userInitials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
            }

            const avatar = sender === 'user'
                ? `<div class="message-avatar">${userInitials}</div>`
                : `<div class="message-avatar">
                    <svg viewBox="0 0 200 200" style="width: 36px; height: 36px;">
                        <circle cx="100" cy="95" r="75" fill="none" stroke="#1da1f2" stroke-width="12"/>
                        <circle cx="100" cy="95" r="60" fill="none" stroke="#2c3e50" stroke-width="8"/>
                        <rect x="35" y="75" width="20" height="45" rx="10" fill="#2c3e50"/>
                        <rect x="145" y="75" width="20" height="45" rx="10" fill="#2c3e50"/>
                        <path d="M 55 75 Q 100 40 145 75" fill="none" stroke="#1da1f2" stroke-width="14" stroke-linecap="round"/>
                        <path d="M 100 120 Q 105 140 120 145" fill="none" stroke="#2c3e50" stroke-width="10" stroke-linecap="round"/>
                        <ellipse cx="125" cy="147" rx="8" ry="10" fill="#2c3e50"/>
                    </svg>
                </div>`;

            const time = getCurrentTime();

            const messageContent = allowHtml ? text : escapeHtml(text);

            messageDiv.innerHTML = `
                ${avatar}
                <div>
                    <div class="message-content">${messageContent}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;

            // Insertar mensaje - verificar si typingIndicator existe
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator && typingIndicator.parentNode === messagesContainer) {
                messagesContainer.insertBefore(messageDiv, typingIndicator);
            } else {
                messagesContainer.appendChild(messageDiv);
            }

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Save to history
            messageHistory.push({
                text,
                sender,
                timestamp: new Date().toISOString()
            });
            saveMessageHistory();

            // PAQUETE 1 - Retornar elemento para poder modificarlo después
            return messageDiv;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').classList.add('active');
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('active');
        }

        // ==========================================
        // WIDGETS
        // ==========================================
        // ==========================================
        // GOOGLE CALENDAR API
        // ==========================================
        
        async function loadCalendarEvents() {
            if (!accessToken) return null;
            
            try {
                // Obtener eventos de hoy
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const response = await fetch(
                    `https://www.googleapis.com/calendar/v3/calendars/primary/events?` +
                    `timeMin=${today.toISOString()}` +
                    `&timeMax=${tomorrow.toISOString()}` +
                    `&singleEvents=true` +
                    `&orderBy=startTime` +
                    `&maxResults=10`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                if (response.status === 401) {
                    handleTokenExpired();
                    return null;
                }
                
                const data = await response.json();
                return data.items || [];
            } catch (error) {
                console.error('Error cargando eventos de Calendar:', error);
                return null;
            }
        }
        
        // ==========================================
        // GMAIL API
        // ==========================================
        
        async function loadGmailMessages() {
            if (!accessToken) return null;
            
            try {
                // Obtener últimos 10 emails no leídos
                const response = await fetch(
                    `https://gmail.googleapis.com/gmail/v1/users/me/messages?` +
                    `maxResults=10` +
                    `&q=is:unread`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                if (response.status === 401) {
                    handleTokenExpired();
                    return null;
                }
                
                const data = await response.json();
                
                if (!data.messages) return [];
                
                // Obtener detalles de cada mensaje
                const messages = await Promise.all(
                    data.messages.slice(0, 5).map(async (msg) => {
                        try {
                            const detailResponse = await fetch(
                                `https://gmail.googleapis.com/gmail/v1/users/me/messages/${msg.id}?format=metadata&metadataHeaders=From&metadataHeaders=Subject`,
                                {
                                    headers: {
                                        'Authorization': `Bearer ${accessToken}`
                                    }
                                }
                            );
                            return await detailResponse.json();
                        } catch (error) {
                            console.error('Error obteniendo detalle de mensaje:', error);
                            return null;
                        }
                    })
                );
                
                return messages.filter(m => m !== null);
            } catch (error) {
                console.error('Error cargando mensajes de Gmail:', error);
                return null;
            }
        }
        
        // ==========================================
        // ==========================================
        // ACTUALIZAR WIDGETS CON DATOS REALES
        // ==========================================
        
        async function updateWidgetsSummary() {
            if (!accessToken) return;
            
            try {
                // Cargar datos de las APIs
                await loadAllAPIsData();
                
                console.log('✅ Resumen de widgets actualizado');
            } catch (error) {
                console.error('Error actualizando widgets:', error);
            }
        }

        async function openWidget(widgetName) {
            if (!accessToken) {
                addMessageToChat('Por favor inicia sesión para ver esta información.', 'ai');
                return;
            }
            
            // Mostrar indicador de carga
            showTypingIndicator();
            
            try {
                switch (widgetName) {
                    case 'calendar':
                        await showCalendarWidget();
                        break;
                    case 'contacts':
                        await showContactsWidget();
                        break;
                    case 'reminders':
                        await showRemindersWidget();
                        break;
                    default:
                        // Para otros widgets, usar mensaje predefinido
                        const messages = {
                            news: '📰 Muéstrame las últimas noticias',
                            sports: '⚽ Muéstrame los resultados de fútbol',
                            finance: '💰 Muéstrame mi resumen financiero'
                        };
                        
                        if (messages[widgetName]) {
                            hideTypingIndicator();
                            document.getElementById('messageInput').value = messages[widgetName];
                            sendMessage();
                        }
                }
            } catch (error) {
                console.error('Error abriendo widget:', error);
                hideTypingIndicator();
                addMessageToChat('Error al cargar la información. Por favor intenta de nuevo.', 'ai');
            }
        }
        
        // Mostrar widget de calendario
        async function showCalendarWidget() {
            const todayEvents = await loadTodayEvents();
            const tomorrowEvents = await loadTomorrowEvents();
            hideTypingIndicator();
            
            if (!todayEvents && !tomorrowEvents) {
                addMessageToChat('No se pudo cargar tu calendario. Verifica los permisos.', 'ai');
                return;
            }
            
            let html = '<div style="max-width: 600px;">';
            html += '<strong style="font-size: 18px;">📅 Tu Agenda</strong><br><br>';
            
            // EVENTOS DE HOY
            html += '<div style="background: var(--tertiary-dark); padding: 12px; border-radius: 8px; margin-bottom: 12px;">';
            html += `<div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">🔵 Hoy (${todayEvents?.length || 0} eventos)</div>`;
            
            if (todayEvents && todayEvents.length > 0) {
                todayEvents.forEach(event => {
                    const start = event.start.dateTime || event.start.date;
                    const time = event.start.dateTime ? new Date(start).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : 'Todo el día';
                    const title = escapeHtml(event.summary || 'Sin título');
                    
                    html += `
                        <div style="
                            background: rgba(255, 255, 255, 0.05);
                            padding: 8px 10px;
                            margin-bottom: 6px;
                            border-radius: 4px;
                            border-left: 3px solid #667eea;
                        ">
                            <div style="font-size: 13px; color: #667eea; font-weight: 500;">🕐 ${time}</div>
                            <div style="font-size: 14px; margin-top: 2px;">${title}</div>
                        </div>
                    `;
                });
            } else {
                html += '<div style="color: var(--text-secondary); font-size: 14px; padding: 8px;">Sin eventos programados</div>';
            }
            
            html += '</div>';
            
            // EVENTOS DE MAÑANA
            html += '<div style="background: var(--tertiary-dark); padding: 12px; border-radius: 8px; margin-bottom: 16px;">';
            html += `<div style="font-weight: 600; color: #9333ea; margin-bottom: 8px;">📌 Mañana (${tomorrowEvents?.length || 0} eventos)</div>`;
            
            if (tomorrowEvents && tomorrowEvents.length > 0) {
                tomorrowEvents.forEach(event => {
                    const start = event.start.dateTime || event.start.date;
                    const time = event.start.dateTime ? new Date(start).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : 'Todo el día';
                    const title = escapeHtml(event.summary || 'Sin título');
                    
                    html += `
                        <div style="
                            background: rgba(255, 255, 255, 0.05);
                            padding: 8px 10px;
                            margin-bottom: 6px;
                            border-radius: 4px;
                            border-left: 3px solid #9333ea;
                        ">
                            <div style="font-size: 13px; color: #9333ea; font-weight: 500;">🕐 ${time}</div>
                            <div style="font-size: 14px; margin-top: 2px;">${title}</div>
                        </div>
                    `;
                });
            } else {
                html += '<div style="color: var(--text-secondary); font-size: 14px; padding: 8px;">Sin eventos programados</div>';
            }
            
            html += '</div>';
            
            // BOTONES DE ACCIÓN (ICONOS SVG PROFESIONALES)
            html += `
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px;">
                    <a href="https://calendar.google.com/calendar/u/0/r/week" target="_blank" style="
                        background: var(--secondary-dark);
                        color: var(--text-primary);
                        padding: 10px 16px;
                        border-radius: 8px;
                        text-decoration: none;
                        font-size: 14px;
                        font-weight: 500;
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                        border: 1px solid var(--border-color);
                        transition: all 0.2s;
                    " onmouseover="this.style.background='var(--tertiary-dark)'; this.style.borderColor='var(--accent-blue)'" onmouseout="this.style.background='var(--secondary-dark)'; this.style.borderColor='var(--border-color)'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        Ver semana completa
                    </a>
                    <a href="https://calendar.google.com/calendar/u/0/r/month" target="_blank" style="
                        background: var(--secondary-dark);
                        color: var(--text-primary);
                        padding: 10px 16px;
                        border-radius: 8px;
                        text-decoration: none;
                        font-size: 14px;
                        font-weight: 500;
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                        border: 1px solid var(--border-color);
                        transition: all 0.2s;
                    " onmouseover="this.style.background='var(--tertiary-dark)'; this.style.borderColor='var(--accent-blue)'" onmouseout="this.style.background='var(--secondary-dark)'; this.style.borderColor='var(--border-color)'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                            <path d="M8 14h.01"></path>
                            <path d="M12 14h.01"></path>
                            <path d="M16 14h.01"></path>
                            <path d="M8 18h.01"></path>
                            <path d="M12 18h.01"></path>
                            <path d="M16 18h.01"></path>
                        </svg>
                        Ver mes completo
                    </a>
                    <a href="https://calendar.google.com/calendar/u/0/r/eventedit" target="_blank" style="
                        background: var(--accent-blue);
                        color: white;
                        padding: 10px 16px;
                        border-radius: 8px;
                        text-decoration: none;
                        font-size: 14px;
                        font-weight: 500;
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                        border: 1px solid var(--accent-blue);
                        transition: all 0.2s;
                    " onmouseover="this.style.background='var(--accent-blue-hover)'" onmouseout="this.style.background='var(--accent-blue)'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Crear evento
                    </a>
                </div>
            `;
            
            html += '</div>';
            addMessageToChat(html, 'ai', true);
        }
        
        // Mostrar widget de recordatorios
        async function showRemindersWidget() {
            const todayReminders = await loadRemindersToday();
            const tomorrowReminders = await loadRemindersTomorrow();
            hideTypingIndicator();
            
            if (!todayReminders && !tomorrowReminders) {
                addMessageToChat('No se pudo cargar tus recordatorios. Verifica los permisos.', 'ai');
                return;
            }
            
            let html = '<div style="max-width: 600px;">';
            html += '<strong style="font-size: 18px;">📋 Recordatorios</strong><br><br>';
            
            // RECORDATORIOS DE HOY
            html += '<div style="background: var(--tertiary-dark); padding: 12px; border-radius: 8px; margin-bottom: 12px;">';
            html += '<div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">🔵 Hoy (' + (todayReminders?.length || 0) + ' recordatorios)</div>';
            
            if (todayReminders && todayReminders.length > 0) {
                todayReminders.forEach(function(event) {
                    const start = event.start.dateTime || event.start.date;
                    const time = event.start.dateTime ? new Date(start).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : 'Todo el día';
                    const title = escapeHtml(event.summary || 'Sin título');
                    
                    html += '<div style="background: rgba(255, 255, 255, 0.05); padding: 8px 10px; margin-bottom: 6px; border-radius: 4px; border-left: 3px solid #667eea;">';
                    html += '<div style="font-size: 13px; color: #667eea; font-weight: 500;">🕐 ' + time + '</div>';
                    html += '<div style="font-size: 14px; margin-top: 2px;">' + title + '</div>';
                    html += '</div>';
                });
            } else {
                html += '<div style="color: var(--text-secondary); font-size: 14px; padding: 8px;">Sin recordatorios programados</div>';
            }
            
            html += '</div>';
            
            // RECORDATORIOS DE MAÑANA
            html += '<div style="background: var(--tertiary-dark); padding: 12px; border-radius: 8px; margin-bottom: 16px;">';
            html += '<div style="font-weight: 600; color: #9333ea; margin-bottom: 8px;">📌 Mañana (' + (tomorrowReminders?.length || 0) + ' recordatorios)</div>';
            
            if (tomorrowReminders && tomorrowReminders.length > 0) {
                tomorrowReminders.forEach(function(event) {
                    const start = event.start.dateTime || event.start.date;
                    const time = event.start.dateTime ? new Date(start).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : 'Todo el día';
                    const title = escapeHtml(event.summary || 'Sin título');
                    
                    html += '<div style="background: rgba(255, 255, 255, 0.05); padding: 8px 10px; margin-bottom: 6px; border-radius: 4px; border-left: 3px solid #9333ea;">';
                    html += '<div style="font-size: 13px; color: #9333ea; font-weight: 500;">🕐 ' + time + '</div>';
                    html += '<div style="font-size: 14px; margin-top: 2px;">' + title + '</div>';
                    html += '</div>';
                });
            } else {
                html += '<div style="color: var(--text-secondary); font-size: 14px; padding: 8px;">Sin recordatorios programados</div>';
            }
            
            html += '</div>';
            
            // BOTONES DE ACCIÓN
            const calendarUrl = 'https://calendar.google.com/calendar/u/0/r?cid=' + encodeURIComponent(REMINDERS_CALENDAR_ID);
            const createReminderUrl = 'https://calendar.google.com/calendar/u/0/r/eventedit?add=' + encodeURIComponent(REMINDERS_CALENDAR_ID);
            
            html += '<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px;">';
            html += '<a href="' + calendarUrl + '" target="_blank" style="background: var(--secondary-dark); color: var(--text-primary); padding: 10px 16px; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; border: 1px solid var(--border-color); transition: all 0.2s;" onmouseover="this.style.background=\'var(--tertiary-dark)\'; this.style.borderColor=\'var(--accent-blue)\'" onmouseout="this.style.background=\'var(--secondary-dark)\'; this.style.borderColor=\'var(--border-color)\'">';
            html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>';
            html += 'Ver calendario completo</a>';
            html += '<a href="' + createReminderUrl + '" target="_blank" style="background: var(--accent-blue); color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; border: 1px solid var(--accent-blue); transition: all 0.2s;" onmouseover="this.style.background=\'var(--accent-blue-hover)\'" onmouseout="this.style.background=\'var(--accent-blue)\'">';
            html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
            html += 'Crear recordatorio</a>';
            html += '</div>';
            
            html += '</div>';
            
            addMessageToChat(html, 'ai', true);
        }
        
        // Mostrar widget de contactos
        async function showContactsWidget() {
            hideTypingIndicator();
            
            let html = '<div style="max-width: 600px;">';
            html += '<strong style="font-size: 18px;">Contactos</strong><br><br>';
            
            // BARRA DE BÚSQUEDA CON BOTÓN
            const searchId = 'contactSearchInput_' + Date.now();
            const searchBtnId = 'contactSearchBtn_' + Date.now();
            const resultsId = 'contactSearchResults_' + Date.now();
            
            html += '<div style="background: var(--tertiary-dark); padding: 12px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; border: 1px solid var(--border-color);">';
            html += '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>';
            html += '<input type="text" placeholder="Buscar contacto por nombre o email..." id="' + searchId + '" style="flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 14px; outline: none;" />';
            html += '<button id="' + searchBtnId + '" style="background: var(--accent-blue); color: white; padding: 8px 16px; border-radius: 6px; border: 1px solid var(--accent-blue); font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.background=\'var(--accent-blue-hover)\'" onmouseout="this.style.background=\'var(--accent-blue)\'">';
            html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>';
            html += 'Buscar</button>';
            html += '</div>';
            
            // ÁREA DE RESULTADOS
            html += '<div id="' + resultsId + '" style="margin-bottom: 16px;"></div>';
            
            // BOTONES PRINCIPALES
            html += '<div style="display: flex; gap: 10px; flex-wrap: wrap;">';
            html += '<a href="https://contacts.google.com/" target="_blank" style="background: var(--secondary-dark); color: var(--text-primary); padding: 10px 16px; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; border: 1px solid var(--border-color); transition: all 0.2s;" onmouseover="this.style.background=\'var(--tertiary-dark)\'; this.style.borderColor=\'var(--accent-blue)\'" onmouseout="this.style.background=\'var(--secondary-dark)\'; this.style.borderColor=\'var(--border-color)\'">';
            html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>';
            html += 'Ver todos los contactos</a>';
            html += '<a href="https://contacts.google.com/new" target="_blank" style="background: var(--accent-blue); color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; border: 1px solid var(--accent-blue); transition: all 0.2s;" onmouseover="this.style.background=\'var(--accent-blue-hover)\'" onmouseout="this.style.background=\'var(--accent-blue)\'">';
            html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
            html += 'Agregar nuevo contacto</a>';
            html += '</div>';
            html += '</div>';
            
            addMessageToChat(html, 'ai', true);
            
            // IMPORTANTE: Conectar eventos DESPUÉS de que el HTML esté en el DOM
            setTimeout(function() {
                const inputElement = document.getElementById(searchId);
                const btnElement = document.getElementById(searchBtnId);
                const resultsElement = document.getElementById(resultsId);
                
                console.log('🔍 Elementos encontrados:', {
                    input: inputElement ? 'SI' : 'NO',
                    button: btnElement ? 'SI' : 'NO',
                    results: resultsElement ? 'SI' : 'NO'
                });
                
                if (inputElement && btnElement && resultsElement) {
                    const performSearch = function() {
                        const query = inputElement.value.trim();
                        console.log('🔍 Buscando:', query);
                        
                        if (!query) {
                            alert('Por favor ingresa un nombre o email para buscar');
                            return;
                        }
                        
                        searchContactsInGoogle(query, resultsElement);
                    };
                    
                    // Click en botón
                    btnElement.onclick = performSearch;
                    
                    // Enter en input
                    inputElement.onkeypress = function(e) {
                        if (e.key === 'Enter') {
                            performSearch();
                        }
                    };
                    
                    console.log('✅ Eventos de búsqueda conectados correctamente');
                } else {
                    console.error('❌ No se pudieron encontrar los elementos del buscador');
                }
            }, 200);
        }
        
        // Función para buscar en Google Contacts API
        async function searchContactsInGoogle(query, resultsContainer) {
            if (!accessToken) {
                alert('Por favor inicia sesión primero');
                return;
            }
            
            // Mostrar loading
            resultsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);"><div style="font-size: 14px;">🔍 Buscando contactos...</div></div>';
            
            try {
                const response = await fetch(
                    'https://people.googleapis.com/v1/people:searchContacts?' +
                    'query=' + encodeURIComponent(query) +
                    '&readMask=names,emailAddresses,phoneNumbers,photos' +
                    '&pageSize=50',
                    {
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        }
                    }
                );
                
                if (response.status === 401) {
                    handleTokenExpired();
                    return;
                }
                
                const data = await response.json();
                const results = data.results || [];
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div style="background: var(--tertiary-dark); padding: 20px; border-radius: 8px; text-align: center; border: 1px solid var(--border-color);"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 12px; opacity: 0.5;"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg><div style="font-size: 16px; margin-bottom: 8px;">No se encontraron contactos</div><div style="font-size: 13px; color: var(--text-secondary);">Intenta con otro nombre o email</div></div>';
                    return;
                }
                
                // Mostrar resultados
                let html = '<div style="margin-bottom: 12px; color: var(--text-secondary); font-size: 13px;">Se encontraron ' + results.length + ' contactos:</div>';
                html += '<div style="display: grid; gap: 10px;">';
                
                results.forEach(function(result) {
                    const contact = result.person;
                    const name = contact.names?.[0]?.displayName || 'Sin nombre';
                    const email = contact.emailAddresses?.[0]?.value || '';
                    const phone = contact.phoneNumbers?.[0]?.value || '';
                    const photo = contact.photos?.[0]?.url || '';
                    const initial = name.charAt(0).toUpperCase();
                    
                    html += '<div style="background: var(--tertiary-dark); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border-color);">';
                    
                    if (photo) {
                        html += '<img src="' + photo + '" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">';
                    } else {
                        html += '<div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 20px;">' + initial + '</div>';
                    }
                    
                    html += '<div style="flex: 1; min-width: 0;">';
                    html += '<div style="font-weight: 600; font-size: 15px; margin-bottom: 2px;">' + escapeHtml(name) + '</div>';
                    if (email) {
                        html += '<div style="font-size: 12px; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + escapeHtml(email) + '</div>';
                    }
                    if (phone) {
                        html += '<div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">' + escapeHtml(phone) + '</div>';
                    }
                    html += '</div>';
                    
                    html += '<div style="display: flex; gap: 8px; flex-shrink: 0;">';
                    if (phone) {
                        html += '<a href="tel:' + phone + '" title="Llamar" style="background: var(--secondary-dark); color: var(--text-primary); width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center; text-decoration: none; border: 1px solid var(--border-color); transition: all 0.2s;" onmouseover="this.style.background=\'var(--tertiary-dark)\'; this.style.borderColor=\'var(--accent-blue)\'" onmouseout="this.style.background=\'var(--secondary-dark)\'; this.style.borderColor=\'var(--border-color)\'">';
                        html += '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>';
                        html += '</a>';
                    }
                    html += '<button onclick="showContactInfo(\'' + escapeHtml(name) + '\', \'' + escapeHtml(email) + '\', \'' + escapeHtml(phone) + '\', \'' + photo + '\')" title="Ver información" style="background: var(--secondary-dark); color: var(--text-primary); width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'var(--tertiary-dark)\'; this.style.borderColor=\'var(--accent-blue)\'" onmouseout="this.style.background=\'var(--secondary-dark)\'; this.style.borderColor=\'var(--border-color)\'">';
                    html += '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
                    html += '</button>';
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>';
                resultsContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Error buscando contactos:', error);
                resultsContainer.innerHTML = '<div style="background: var(--tertiary-dark); padding: 20px; border-radius: 8px; text-align: center; border: 1px solid var(--error-red);"><div style="font-size: 16px; color: var(--error-red); margin-bottom: 8px;">Error al buscar</div><div style="font-size: 13px; color: var(--text-secondary);">Por favor intenta de nuevo</div></div>';
            }
        }
        // Función para mostrar información detallada del contacto
        window.showContactInfo = function(name, email, phone, photo) {
            const initial = name.charAt(0).toUpperCase();
            
            let infoHtml = '<div style="max-width: 400px;">';
            infoHtml += '<div style="background: var(--tertiary-dark); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">';
            
            // Avatar
            infoHtml += '<div style="text-align: center; margin-bottom: 16px;">';
            if (photo) {
                infoHtml += `<img src="${photo}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-blue);">`;
            } else {
                infoHtml += `<div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 32px; border: 3px solid var(--accent-blue);">${initial}</div>`;
            }
            infoHtml += '</div>';
            
            // Nombre
            infoHtml += `<div style="text-align: center; font-size: 20px; font-weight: 600; margin-bottom: 20px;">${escapeHtml(name)}</div>`;
            
            // Información de contacto
            if (email) {
                infoHtml += `
                    <div style="background: var(--secondary-dark); padding: 12px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border-color);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                            <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
                        </svg>
                        <div style="flex: 1;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 2px;">EMAIL</div>
                            <div style="font-size: 14px; word-break: break-all;">${escapeHtml(email)}</div>
                        </div>
                        <a href="mailto:${email}" style="
                            background: var(--accent-blue);
                            color: white;
                            padding: 6px 12px;
                            border-radius: 6px;
                            text-decoration: none;
                            font-size: 12px;
                            border: none;
                        ">Enviar</a>
                    </div>
                `;
            }
            
            if (phone) {
                infoHtml += `
                    <div style="background: var(--secondary-dark); padding: 12px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border-color);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        <div style="flex: 1;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 2px;">TELÉFONO</div>
                            <div style="font-size: 14px;">${escapeHtml(phone)}</div>
                        </div>
                        <a href="tel:${phone}" style="
                            background: var(--accent-blue);
                            color: white;
                            padding: 6px 12px;
                            border-radius: 6px;
                            text-decoration: none;
                            font-size: 12px;
                            border: none;
                        ">Llamar</a>
                    </div>
                `;
            }
            
            infoHtml += '</div></div>';
            
            addMessageToChat(infoHtml, 'ai', true);
        }
        
        // ==========================================
        // FILE HANDLING
        // ==========================================
        async function sendFileMessage(message, file, isMultiple = false) {
            // Crear mensaje visual que muestre archivo + caption juntos
            const fileIcon = getFileIcon(file.type);
            let visualMessage = `${fileIcon} <strong>${file.name}</strong>`;

            // Si hay caption, agregarlo debajo del archivo
            if (message && !isMultiple) {
                visualMessage += `<br><span style="color: var(--text-secondary); font-size: 14px;">${escapeHtml(message)}</span>`;
            }

            // PAQUETE 1 - Si es imagen, mostrar preview
            if (file.type.startsWith('image/')) {
                const base64 = await fileToBase64(file);
                visualMessage += `<br><img src="${base64}" class="message-image-preview" alt="${file.name}">`;
            }

            // Solo mostrar mensaje individual si NO es parte de envío múltiple
            let messageElement = null;
            if (!isMultiple) {
                // Agregar checkmark (✓ enviado)
                visualMessage += `<div class="message-status"><span class="check sent">✓</span><span class="check received" style="display: none;">✓</span></div>`;
                messageElement = addMessageToChat(visualMessage, 'user', true);
            }

            // Mostrar indicadores solo si es archivo único
            if (!isMultiple) {
                showUploadIndicator();
                showTypingIndicator();
            }

            try {
                const base64 = file.type.startsWith('image/') ?
                    await fileToBase64(file) :
                    await fileToBase64(file);

                const fileData = {
                    type: file.type.startsWith('image/') ? 'image' : 'document',
                    name: file.name,
                    mimeType: file.type,
                    base64: base64.split(',')[1] // Remover el prefijo data:...
                };

                // Enviar archivo con caption
                const response = await sendToN8N(message || '', fileData);

                // Marcar como recibido (✓✓) solo si es individual
                if (!isMultiple && messageElement) {
                    markAsReceived(messageElement);
                }

                if (!isMultiple) {
                    hideUploadIndicator();
                    hideTypingIndicator();

                    // Mostrar respuesta solo si es individual
                    let stefyMessage = response.output || response.response || response.message || 'Archivo procesado correctamente.';
                    addMessageToChat(stefyMessage, 'ai');
                }

                return response;

            } catch (error) {
                console.error('Error sending file:', error);
                if (!isMultiple) {
                    hideUploadIndicator();
                    hideTypingIndicator();
                    addMessageToChat('Lo siento, hubo un error al procesar el archivo. Por favor intenta de nuevo.', 'ai');
                }
                throw error; // Re-throw para que sendMultipleFiles lo capture
            }
        }

        // PAQUETE 1 - Marcar mensaje como recibido
        function markAsReceived(messageElement) {
            if (!messageElement) return;
            const receivedCheck = messageElement.querySelector('.check.received');
            if (receivedCheck) {
                receivedCheck.style.display = 'inline';
            }
        }


        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return '🖼️';
            if (mimeType.includes('pdf')) return '📄';
            if (mimeType.includes('word') || mimeType.includes('document')) return '📝';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return '📊';
            return '📎';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function clearFileSelection() {
            selectedFile = null;
            selectedFiles = [];
            document.getElementById('fileInput').value = '';

            // Restaurar preview original
            const preview = document.getElementById('filePreview');
            preview.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="filePreviewIcon" style="font-size: 24px;">📄</span>
                    <div style="flex: 1;">
                        <div id="filePreviewName" style="font-size: 14px; font-weight: 500;"></div>
                        <div id="filePreviewSize" style="font-size: 12px; color: var(--text-secondary);"></div>
                    </div>
                    <button onclick="clearFileSelection()" style="background: var(--error-red); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                        ✕
                    </button>
                </div>
                <div id="quickActions" class="quick-actions" style="display: none;">
                    <button class="quick-action-btn" data-action="factura">🧾 Factura</button>
                    <button class="quick-action-btn" data-action="gasto">💰 Gasto</button>
                    <button class="quick-action-btn" data-action="guardar">💾 Guardar</button>
                </div>
            `;
            preview.style.display = 'none';

            // Restaurar placeholder original
            const messageInput = document.getElementById('messageInput');
            messageInput.placeholder = 'Escribe tu mensaje...';
        }

        // ==========================================
        // VOICE RECORDING
        // ==========================================
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Configurar opciones de grabación
                let options = { mimeType: 'audio/ogg; codecs=opus' };

                // Fallback si el navegador no soporta OGG
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options = { mimeType: 'audio/webm; codecs=opus' };
                    console.log('OGG no soportado, usando WebM');
                }

                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];

                console.log('Grabando con formato:', mediaRecorder.mimeType);

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const mimeType = mediaRecorder.mimeType;
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    await sendAudioMessage(audioBlob, mimeType);

                    // Detener el stream
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();

                // Mostrar UI de grabación
                document.getElementById('voiceRecorder').style.display = 'block';
                document.getElementById('voiceBtn').classList.add('recording');

                // Iniciar contador
                recordingStartTime = Date.now();
                recordingInterval = setInterval(updateRecordingTime, 100);

            } catch (error) {
                console.error('Error al acceder al micrófono:', error);
                alert('No se pudo acceder al micrófono. Por favor verifica los permisos.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
                document.getElementById('voiceRecorder').style.display = 'none';
                document.getElementById('voiceBtn').classList.remove('recording');
            }
        }

        function cancelRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                audioChunks = [];
                clearInterval(recordingInterval);
                document.getElementById('voiceRecorder').style.display = 'none';
                document.getElementById('voiceBtn').classList.remove('recording');
            }
        }

        function updateRecordingTime() {
            const elapsed = Date.now() - recordingStartTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            document.getElementById('recordingTime').textContent =
                `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        async function sendAudioMessage(audioBlob, mimeType) {
            // PAQUETE 1 - Crear reproductor de audio
            const audioUrl = URL.createObjectURL(audioBlob);
            const audioId = 'audio_' + Date.now();
            savedAudioBlobs[audioId] = audioUrl;

            const duration = recordingStartTime ? Math.floor((Date.now() - recordingStartTime) / 1000) : 0;
            const durationText = formatDuration(duration);

            const voicePlayerHTML = `
                <div class="voice-message-player">
                    <button class="play-voice-btn" data-audio-id="${audioId}">
                        <span class="play-icon">▶️</span>
                    </button>
                    <div class="voice-waveform" style="--progress: 0%"></div>
                    <span class="voice-duration">${durationText}</span>
                </div>
            `;

            addMessageToChat(voicePlayerHTML, 'user', true);
            showTypingIndicator();

            try {
                const base64 = await blobToBase64(audioBlob);

                // Detectar extensión según MIME type
                let extension = 'ogg';
                if (mimeType.includes('webm')) extension = 'webm';
                if (mimeType.includes('wav')) extension = 'wav';
                if (mimeType.includes('mp4')) extension = 'mp4';

                console.log('Enviando audio:', {
                    mimeType: mimeType,
                    extension: extension,
                    size: audioBlob.size + ' bytes'
                });

                const audioData = {
                    type: 'audio',
                    name: `voice_message.${extension}`,
                    mimeType: mimeType,
                    base64: base64.split(',')[1] // Remover prefijo data:audio/...;base64,
                };

                const response = await sendToN8N('', audioData);

                hideTypingIndicator();

                let stefyMessage = response.output || response.response || response.message || 'Audio procesado correctamente.';
                addMessageToChat(stefyMessage, 'ai');

            } catch (error) {
                console.error('Error sending audio:', error);
                hideTypingIndicator();
                addMessageToChat('Lo siento, hubo un error al procesar el audio. Por favor intenta de nuevo.', 'ai');
            }
        }

        // PAQUETE 1 - Formatear duración de audio
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }


        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // ==========================================
        // UTILITIES
        // ==========================================
        // PAQUETE 2 - Timestamps mejorados
        function getCurrentTime() {
            const now = new Date();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            const messageDate = new Date(now);
            messageDate.setHours(0, 0, 0, 0);

            const time = now.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // Si es hoy
            if (messageDate.getTime() === today.getTime()) {
                return `Hoy ${time}`;
            }

            // Si es ayer
            if (messageDate.getTime() === yesterday.getTime()) {
                return `Ayer ${time}`;
            }

            // Si es otra fecha
            return now.toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function saveMessageHistory() {
            localStorage.setItem('stefy_messages', JSON.stringify(messageHistory.slice(-50))); // Keep last 50 messages
        }

        function loadMessageHistory() {
            const saved = localStorage.getItem('stefy_messages');
            if (saved) {
                messageHistory = JSON.parse(saved);
                // Optionally, display saved messages
            }
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar sistema de widgets personalizables
            initializeWidgets();
            
            // Inicializar Google OAuth
            initGoogleAuth();

            // Restaurar token si existe
            const savedToken = localStorage.getItem('google_access_token');
            const savedExpiry = localStorage.getItem('google_token_expiry');
            
            if (savedToken && savedExpiry) {
                accessToken = savedToken;
                
                // Verificar si el token aún es válido
                if (isTokenExpired()) {
                    console.warn('Token guardado ya expiró');
                    handleTokenExpired();
                } else {
                    console.log('✅ Token restaurado desde localStorage');
                    // Iniciar sistema de refresh automático
                    startTokenRefreshTimer();
                }
            }

            // Check if user is already logged in
            const savedUser = localStorage.getItem('stefy_user');
            if (savedUser) {
                loginUser(JSON.parse(savedUser));
            }

            // Auto-resize textarea
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Send on Enter (Shift+Enter for new line)
            messageInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Attach file button
            const attachBtn = document.getElementById('attachBtn');
            const fileInput = document.getElementById('fileInput');

            attachBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);

                if (files.length === 0) return;

                if (files.length === 1) {
                    // Un solo archivo
                    selectedFile = files[0];
                    selectedFiles = [];
                    showSingleFilePreview(files[0]);
                } else {
                    // Múltiples archivos
                    selectedFile = null;
                    selectedFiles = files;
                    showMultipleFilesPreview(files);
                }
            });

            function showSingleFilePreview(file) {
                const preview = document.getElementById('filePreview');
                const icon = document.getElementById('filePreviewIcon');
                const name = document.getElementById('filePreviewName');
                const size = document.getElementById('filePreviewSize');
                const quickActions = document.getElementById('quickActions');

                icon.textContent = getFileIcon(file.type);
                name.textContent = file.name;
                size.textContent = formatFileSize(file.size);
                preview.style.display = 'block';

                // Mostrar botones de acción rápida
                quickActions.style.display = 'flex';
                quickActions.classList.add('fade-in');

                // Cambiar placeholder
                const messageInput = document.getElementById('messageInput');
                messageInput.placeholder = 'O escribe: "Factura", "Gasto" o "Guardar" (opcional)';
            }

            function showMultipleFilesPreview(files) {
                const preview = document.getElementById('filePreview');
                preview.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>${files.length} archivos seleccionados</strong>
                        <button onclick="clearFileSelection()" style="float: right; background: var(--error-red); color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer;">
                            ✕ Cancelar
                        </button>
                    </div>
                    <div class="multiple-files-preview" id="multipleFilesList"></div>
                    <div id="quickActions" class="quick-actions" style="margin-top: 10px;">
                        <button class="quick-action-btn" data-action="factura">🧾 Factura</button>
                        <button class="quick-action-btn" data-action="gasto">💰 Gasto</button>
                        <button class="quick-action-btn" data-action="guardar">💾 Guardar</button>
                    </div>
                `;

                const filesList = document.getElementById('multipleFilesList');
                files.forEach((file, index) => {
                    const item = document.createElement('div');
                    item.className = 'file-preview-item fade-in';
                    item.style.animationDelay = `${index * 0.05}s`;
                    item.innerHTML = `
                        <span style="font-size: 20px;">${getFileIcon(file.type)}</span>
                        <div style="flex: 1;">
                            <div style="font-size: 13px;">${file.name}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">${formatFileSize(file.size)}</div>
                        </div>
                        <button class="remove-file" onclick="removeFileFromSelection(${index})">✕</button>
                    `;
                    filesList.appendChild(item);
                });

                preview.style.display = 'block';

                // Cambiar placeholder
                const messageInput = document.getElementById('messageInput');
                messageInput.placeholder = 'O escribe: "Factura", "Gasto" o "Guardar" (opcional)';
            }

            function removeFileFromSelection(index) {
                selectedFiles.splice(index, 1);
                if (selectedFiles.length === 0) {
                    clearFileSelection();
                } else {
                    showMultipleFilesPreview(selectedFiles);
                }
            }


            // Voice recording button
            const voiceBtn = document.getElementById('voiceBtn');
            voiceBtn.addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                } else {
                    startRecording();
                }
            });

            // PAQUETE 1 - Event listeners para botones de acción rápida
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('quick-action-btn')) {
                    const action = e.target.dataset.action;
                    const messageInput = document.getElementById('messageInput');

                    // Mapear acción a texto
                    const actionTexts = {
                        'factura': 'Factura',
                        'gasto': 'Gasto',
                        'guardar': 'Guardar'
                    };

                    messageInput.value = actionTexts[action] || '';
                    messageInput.focus();

                    // Enviar automáticamente
                    setTimeout(() => sendMessage(), 100);
                }

                // PAQUETE 1 - Reproducir mensaje de voz
                if (e.target.closest('.play-voice-btn')) {
                    const btn = e.target.closest('.play-voice-btn');
                    const audioId = btn.dataset.audioId;
                    const audioUrl = savedAudioBlobs[audioId];

                    if (audioUrl) {
                        // Si ya hay un audio reproduciéndose, detenerlo
                        if (currentAudio) {
                            currentAudio.pause();
                            currentAudio = null;
                            document.querySelectorAll('.play-voice-btn').forEach(b => {
                                b.classList.remove('playing');
                                b.querySelector('.play-icon').textContent = '▶️';
                            });
                        }

                        // Reproducir nuevo audio
                        currentAudio = new Audio(audioUrl);
                        btn.classList.add('playing');
                        btn.querySelector('.play-icon').textContent = '⏸️';

                        currentAudio.play();

                        currentAudio.onended = () => {
                            btn.classList.remove('playing');
                            btn.querySelector('.play-icon').textContent = '▶️';
                            currentAudio = null;
                        };

                        // Actualizar barra de progreso
                        currentAudio.ontimeupdate = () => {
                            const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
                            const waveform = btn.parentElement.querySelector('.voice-waveform');
                            if (waveform) {
                                waveform.style.setProperty('--progress', `${progress}%`);
                            }
                        };
                    }
                }
            });

            // PAQUETE 1 - Drag & Drop de archivos
            const chatMessages = document.getElementById('chatMessages');
            const dragOverlay = document.getElementById('dragOverlay');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                chatMessages.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                chatMessages.addEventListener(eventName, () => {
                    chatMessages.classList.add('drag-over');
                    dragOverlay.classList.add('show');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                chatMessages.addEventListener(eventName, () => {
                    chatMessages.classList.remove('drag-over');
                    dragOverlay.classList.remove('show');
                });
            });

            chatMessages.addEventListener('drop', (e) => {
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    handleDroppedFiles(files);
                }
            });

            function handleDroppedFiles(files) {
                // Simular selección de archivos
                const dataTransfer = new DataTransfer();
                files.forEach(file => dataTransfer.items.add(file));
                document.getElementById('fileInput').files = dataTransfer.files;

                // Trigger change event
                const event = new Event('change', { bubbles: true });
                document.getElementById('fileInput').dispatchEvent(event);
            }

            // Online/Offline status
            window.addEventListener('online', () => {
                const status = document.getElementById('connectionStatus');
                if (!status) return; // Si no existe el elemento, salir
                status.className = 'connection-status online';
                status.innerHTML = '<span>🟢</span><span>Conectado</span>';
            });

            window.addEventListener('offline', () => {
                const status = document.getElementById('connectionStatus');
                if (!status) return; // Si no existe el elemento, salir
                status.className = 'connection-status offline';
                status.innerHTML = '<span>🔴</span><span>Sin conexión</span>';
            });

            // ==========================================
            // PAQUETE 2 - NUEVAS FUNCIONALIDADES
            // ==========================================

            // 1. TEMA CLARO/OSCURO
            const themeToggle = document.getElementById('themeToggle');
            const savedTheme = localStorage.getItem('stefy_theme') || 'dark';
            
            const darkIcon = themeToggle.querySelector('.theme-icon-dark');
            const lightIcon = themeToggle.querySelector('.theme-icon-light');

            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                if (darkIcon) darkIcon.style.display = 'none';
                if (lightIcon) lightIcon.style.display = 'block';
            }

            themeToggle.addEventListener('click', toggleTheme);

            function toggleTheme() {
                document.body.classList.toggle('light-theme');
                const isLight = document.body.classList.contains('light-theme');
                
                // Alternar iconos
                if (darkIcon && lightIcon) {
                    darkIcon.style.display = isLight ? 'none' : 'block';
                    lightIcon.style.display = isLight ? 'block' : 'none';
                }
                
                localStorage.setItem('stefy_theme', isLight ? 'light' : 'dark');
            }

            // 2. BÚSQUEDA EN HISTORIAL
            const searchBar = document.getElementById('searchBar');
            const searchInput = document.getElementById('searchInput');
            const closeSearchBtn = document.getElementById('closeSearch');

            function openSearch() {
                searchBar.classList.add('show');
                searchInput.focus();
            }

            function closeSearch() {
                searchBar.classList.remove('show');
                searchInput.value = '';
                clearSearchHighlights();
            }

            function searchMessages(query) {
                const messages = document.querySelectorAll('.message');
                const lowerQuery = query.toLowerCase();

                clearSearchHighlights();

                if (!query) return;

                messages.forEach(msg => {
                    const text = msg.textContent.toLowerCase();
                    if (text.includes(lowerQuery)) {
                        msg.classList.add('search-highlight');
                    }
                });
            }

            function clearSearchHighlights() {
                document.querySelectorAll('.message').forEach(msg => {
                    msg.classList.remove('search-highlight');
                });
            }

            searchInput.addEventListener('input', (e) => {
                searchMessages(e.target.value);
            });

            closeSearchBtn.addEventListener('click', closeSearch);

            // 3. ATAJOS DE TECLADO
            document.addEventListener('keydown', (e) => {
                // Ctrl + F: Búsqueda
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    openSearch();
                }

                // Ctrl + U: Adjuntar archivo
                if (e.ctrlKey && e.key === 'u') {
                    e.preventDefault();
                    document.getElementById('fileInput').click();
                }

                // Ctrl + R: Grabar voz
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    document.getElementById('voiceBtn').click();
                }

                // Ctrl + T: Cambiar tema
                if (e.ctrlKey && e.key === 't') {
                    e.preventDefault();
                    toggleTheme();
                }

                // Escape: Cerrar búsqueda o cancelar
                if (e.key === 'Escape') {
                    if (searchBar.classList.contains('show')) {
                        closeSearch();
                    } else if (mediaRecorder && mediaRecorder.state === 'recording') {
                        cancelRecording();
                    } else if (selectedFile || selectedFiles.length > 0) {
                        clearFileSelection();
                    }
                }
            });

            // 4. SCROLL TO BOTTOM
            const scrollToBottomBtn = document.getElementById('scrollToBottom');
            let isUserScrolling = false;

            chatMessages.addEventListener('scroll', () => {
                const { scrollTop, scrollHeight, clientHeight } = chatMessages;
                const isAtBottom = scrollHeight - scrollTop - clientHeight < 100;

                if (isAtBottom) {
                    scrollToBottomBtn.classList.remove('show');
                    isUserScrolling = false;
                } else {
                    scrollToBottomBtn.classList.add('show');
                    isUserScrolling = true;
                }
            });

            scrollToBottomBtn.addEventListener('click', () => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            });

            // Modificar scrollToBottom existente para usar el flag
            function scrollToBottom(force = false) {
                if (!isUserScrolling || force) {
                    chatMessages.scrollTo({
                        top: chatMessages.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }
        });

        // ==========================================
        // SERVICE WORKER (PWA) - Comentado temporalmente
        // ==========================================
        /*
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        */
    </script>
</body>

</html>
